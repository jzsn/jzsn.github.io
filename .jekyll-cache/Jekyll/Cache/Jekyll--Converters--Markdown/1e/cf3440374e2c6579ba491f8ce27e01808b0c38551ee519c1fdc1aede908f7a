I"wø<p>è¿œç¨‹ç›´æ¥å†…å­˜è®¿é—®(å³Remote Direct Memory Access)æ˜¯ä¸€ç§ç›´æ¥å†…å­˜è®¿é—®æŠ€æœ¯ï¼Œå®ƒè®©è®¡ç®—æœºå¯ä»¥ç›´æ¥å­˜å–å…¶ä»–è®¡ç®—æœºçš„å†…å­˜ï¼Œè€Œä¸éœ€è¦ç»è¿‡æ“ä½œç³»ç»Ÿå’Œå¤„ç†å™¨è€—æ—¶çš„å¤„ç†ã€‚RDMAå°†æ•°æ®ä»ä¸€ä¸ªç³»ç»Ÿå¿«é€Ÿç§»åŠ¨åˆ°è¿œç¨‹ç³»ç»Ÿå­˜å‚¨å™¨ä¸­ï¼Œä¸å¯¹æ“ä½œç³»ç»Ÿé€ æˆä»»ä½•å½±å“ã€‚</p>

<p><img src="https://5b0988e595225.cdn.sohucs.com/images/20180422/c32ef99c45bc418ba29a08d56ae6fbfa.jpeg" alt="æ”¯æŒ RDMA åè®®çš„è®¾å¤‡" /></p>

<p>RDMAæŠ€æœ¯æœ€æ—©å‡ºç°åœ¨Infinibandç½‘ç»œï¼Œç”¨äºHPCé«˜æ€§èƒ½è®¡ç®—é›†ç¾¤çš„äº’è”ã€‚æ”¯æŒ RDMA åè®®çš„è®¾å¤‡ä¸»è¦æœ‰ Infinibandã€RoCEã€iWARP ç½‘å¡ï¼Œåœ¨ HPCã€å¹¶è¡Œå­˜å‚¨ç³»ç»Ÿç­‰é¢†åŸŸå¾—åˆ°å¹¿æ³›åº”ç”¨ã€‚</p>

<h2 id="rdma-vs-tcpip">RDMA VS TCP/IP</h2>

<p>ä¼ ç»Ÿçš„åŸºäºSocketå¥—æ¥å­—(TCP/IPåè®®æ ˆ)çš„ç½‘ç»œé€šä¿¡ï¼Œéœ€è¦ç»è¿‡æ“ä½œç³»ç»Ÿè½¯ä»¶åè®®æ ˆï¼Œæ•°æ®åœ¨ç³»ç»ŸDRAMã€å¤„ç†å™¨Cacheå’Œç½‘å¡Bufferä¹‹é—´æ¥å›æ‹·è´æ¬ç§»ï¼Œå› æ­¤å ç”¨äº†å¤§é‡çš„CPUè®¡ç®—èµ„æºå’Œå†…å­˜æ€»çº¿å¸¦å®½ï¼Œä¹ŸåŠ å¤§äº†ç½‘ç»œå»¶æ—¶ã€‚ä¸¾ä¾‹æ¥è¯´ï¼Œ40Gbpsçš„TCP/IPæµèƒ½è€—å°½ä¸»æµæœåŠ¡å™¨çš„æ‰€æœ‰CPUèµ„æºï¼›RDMAåˆ™è§£å†³äº†ä¼ ç»ŸTCP/IPé€šä¿¡çš„æŠ€æœ¯ç—›ç‚¹ã€‚ä¾‹å¦‚ï¼Œåœ¨40Gbpsåœºæ™¯ä¸‹ï¼ŒCPUå ç”¨ç‡ä»100%ä¸‹é™åˆ°5%ï¼Œç½‘ç»œå»¶æ—¶ä»msçº§é™ä½åˆ°10usä»¥ä¸‹ã€‚</p>

<p>RDMAæŠ€æœ¯çš„åŸç†åŠå…¶ä¸TCP/IPæ¶æ„çš„å¯¹æ¯”å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>

<p><img src="https://5b0988e595225.cdn.sohucs.com/images/20180422/22acd08a57d548e0a83ebd88958b5e1e.jpeg" alt="RDMAæŠ€æœ¯çš„åŸç†åŠå…¶ä¸TCP/IPæ¶æ„çš„å¯¹æ¯”" /></p>

<p>å› æ­¤ï¼Œè‡ªæˆ‘ç†è§£RDMAä¸ºåˆ©ç”¨ç›¸å…³çš„ç¡¬ä»¶å’Œç½‘ç»œæŠ€æœ¯ï¼ŒæœåŠ¡å™¨çš„ç½‘å¡ä¹‹é—´å¯ä»¥ç›´æ¥è¯»å†…å­˜ï¼Œæœ€ç»ˆè¾¾åˆ°é«˜å¸¦å®½ã€ä½å»¶è¿Ÿå’Œä½èµ„æºå ç”¨ç‡çš„æ•ˆæœã€‚åº”ç”¨ç¨‹åºä¸éœ€è¦å‚ä¸æ•°æ®ä¼ è¾“è¿‡ç¨‹ï¼Œåªéœ€è¦æŒ‡å®šå†…å­˜è¯»å†™åœ°å€ï¼Œå¼€å¯ä¼ è¾“å¹¶ç­‰å¾…ä¼ è¾“å®Œæˆå³å¯ã€‚</p>

<h2 id="rdmaçš„ä¸‰ç§å®ç°">RDMAçš„ä¸‰ç§å®ç°</h2>

<p>ç›®å‰RDMAæœ‰ä¸‰ç§ä¸åŒçš„ç¡¬ä»¶å®ç°ã€‚åˆ†åˆ«æ˜¯InfiniBandã€iWarpï¼ˆinternet Wide Area RDMA Protocolï¼‰ã€RoCE(RDMA over Converged Ethernet)ã€‚å…¶ä¸­ï¼ŒInfinibandæ˜¯ä¸€ç§ä¸“ä¸ºRDMAè®¾è®¡çš„ç½‘ç»œï¼Œä»ç¡¬ä»¶çº§åˆ«ä¿è¯å¯é ä¼ è¾“ ï¼Œ è€ŒRoCE å’Œ iWARPéƒ½æ˜¯åŸºäºä»¥å¤ªç½‘çš„RDMAæŠ€æœ¯ï¼Œæ”¯æŒç›¸åº”çš„verbsæ¥å£ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>

<p><img src="https://img-blog.csdn.net/20180604110329770" alt="ä¸‰ç§å®ç°çš„åè®®æ ˆ" /></p>

<p>ä»å›¾ä¸­ä¸éš¾å‘ç°ï¼ŒRoCEåè®®å­˜åœ¨RoCEv1å’ŒRoCEv2ä¸¤ä¸ªç‰ˆæœ¬ï¼Œä¸»è¦åŒºåˆ«RoCEv1æ˜¯åŸºäºä»¥å¤ªç½‘é“¾è·¯å±‚å®ç°çš„RDMAåè®®(äº¤æ¢æœºéœ€è¦æ”¯æŒPFCç­‰æµæ§æŠ€æœ¯ï¼Œåœ¨ç‰©ç†å±‚ä¿è¯å¯é ä¼ è¾“)ï¼Œè€ŒRoCEv2æ˜¯ä»¥å¤ªç½‘TCP/IPåè®®ä¸­UDPå±‚å®ç°ã€‚ä»æ€§èƒ½ä¸Šï¼Œå¾ˆæ˜æ˜¾Infinibandç½‘ç»œæœ€å¥½ï¼Œä½†ç½‘å¡å’Œäº¤æ¢æœºæ˜¯ä»·æ ¼ä¹Ÿå¾ˆé«˜ï¼Œç„¶è€ŒRoCEv2å’ŒiWARPä»…éœ€ä½¿ç”¨ç‰¹æ®Šçš„ç½‘å¡å°±å¯ä»¥äº†ï¼Œä»·æ ¼ä¹Ÿç›¸å¯¹ä¾¿å®œå¾ˆå¤šã€‚</p>

<p>è‡ªå·±å½’çº³ä¸€ä¸‹ï¼Œä¸‰ç§å®ç°ä¹‹é—´çš„åŒºåˆ«ï¼š</p>

<ol>
  <li>IBç½‘æ˜¯ä»ç¡¬ä»¶ä¸Šæ”¯æŒRDMAï¼Œå„æ–¹é¢æ€§èƒ½ä¸Šæœ€ä¼˜ï¼Œä½†æ˜¯å¯¹ç¡¬ä»¶æˆæœ¬è¦æ±‚æœ€é«˜ï¼Œéœ€è¦æ”¯æŒè¯¥æŠ€æœ¯çš„ç½‘å¡å’Œäº¤æ¢æœºã€‚</li>
  <li>ä¸€ä¸ªå…è®¸åœ¨ä»¥å¤ªç½‘ä¸Šæ‰§è¡ŒRDMAçš„ç½‘ç»œåè®®ã€‚ å…¶è¾ƒä½çš„ç½‘ç»œæ ‡å¤´æ˜¯ä»¥å¤ªç½‘æ ‡å¤´ï¼Œå…¶è¾ƒé«˜çš„ç½‘ç»œæ ‡å¤´ï¼ˆåŒ…æ‹¬æ•°æ®ï¼‰æ˜¯InfiniBandæ ‡å¤´ã€‚ è¿™æ”¯æŒåœ¨æ ‡å‡†ä»¥å¤ªç½‘åŸºç¡€è®¾æ–½ï¼ˆäº¤æ¢æœºï¼‰ä¸Šä½¿ç”¨RDMAã€‚ åªæœ‰ç½‘å¡åº”è¯¥æ˜¯ç‰¹æ®Šçš„ï¼Œæ”¯æŒRoCEã€‚</li>
  <li>iWarpä¸€ä¸ªå…è®¸åœ¨TCPä¸Šæ‰§è¡ŒRDMAçš„ç½‘ç»œåè®®ï¼Œå¯èƒ½æ¯”æ™®é€šä»¥å¤ªç½‘è¿˜è¦æ…¢ï¼Œä¸é€‚åˆç”¨äºç”Ÿäº§ç¯å¢ƒã€‚åªæœ‰ç½‘å¡åº”è¯¥æ˜¯ç‰¹æ®Šçš„ï¼Œå¹¶ä¸”æ”¯æŒiWARPï¼ˆå¦‚æœä½¿ç”¨CPUå¸è½½ï¼‰ï¼Œå¦åˆ™æ‰€æœ‰iWARPå †æ ˆéƒ½å¯ä»¥åœ¨SWä¸­å®ç°ï¼Œå¹¶ä¸”ä¸§å¤±äº†å¤§éƒ¨åˆ†RDMAæ€§èƒ½ä¼˜åŠ¿ã€‚IBå’ŒRoCEä¸­å­˜åœ¨çš„åŠŸèƒ½åœ¨iWARPä¸­ä¸å—æ”¯æŒã€‚ è¿™æ”¯æŒåœ¨æ ‡å‡†ä»¥å¤ªç½‘åŸºç¡€è®¾æ–½ï¼ˆäº¤æ¢æœºï¼‰ä¸Šä½¿ç”¨RDMAã€‚</li>
</ol>

<h2 id="ç›¸å…³æ¦‚å¿µ">ç›¸å…³æ¦‚å¿µ</h2>

<h3 id="qpqueue-pair">QP(Queue Pair)</h3>

<p>Queue Pairs(QP)ï¼Œæ¯å¯¹QPç”±Send Queue(SQ)å’ŒReceive Queue(RQ)æ„æˆï¼Œè¿™äº›é˜Ÿåˆ—ä¸­ç®¡ç†ç€å„ç§ç±»å‹çš„æ¶ˆæ¯ã€‚QPä¼šè¢«æ˜ å°„åˆ°åº”ç”¨çš„è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œä½¿å¾—åº”ç”¨ç›´æ¥é€šè¿‡å®ƒè®¿é—®RNICç½‘å¡ã€‚</p>

<h3 id="cqcomplete-queue">CQ(Complete Queue)</h3>

<p>å®Œæˆé˜Ÿåˆ—åŒ…å«äº†å‘é€åˆ°å·¥ä½œé˜Ÿåˆ—ï¼ˆWQï¼‰ä¸­å·²å®Œæˆçš„å·¥ä½œè¯·æ±‚ï¼ˆWRï¼‰ã€‚æ¯æ¬¡å®Œæˆè¡¨ç¤ºä¸€ä¸ªç‰¹å®šçš„ WRæ‰§è¡Œå®Œæ¯•ï¼ˆåŒ…æ‹¬æˆåŠŸå®Œæˆçš„WRå’Œä¸æˆåŠŸå®Œæˆçš„WRï¼‰ã€‚å®Œæˆé˜Ÿåˆ—æ˜¯ä¸€ä¸ªç”¨æ¥å‘ŠçŸ¥åº”ç”¨ç¨‹åºå·²ç»“æŸçš„å·¥ä½œè¯·æ±‚çš„ä¿¡æ¯ï¼ˆçŠ¶æ€ã€æ“ä½œç ã€å¤§å°ã€æ¥æºï¼‰çš„æœºåˆ¶ã€‚CQæœ‰nä¸ªå®Œæˆé˜Ÿåˆ—å®ä½“ï¼ˆCQEï¼‰ã€‚CQEçš„æ•°é‡åœ¨CQåˆ›å»ºçš„æ—¶å€™è¢«æŒ‡å®šã€‚å½“ä¸€ä¸ªCQPè¢«è½®è¯¢åˆ°ï¼Œå®ƒå°±ä»CQä¸­è¢«åˆ é™¤ã€‚CQæ˜¯ä¸€ä¸ªCQEçš„å…ˆè¿›é€‰å‡ºï¼ˆFIFOï¼‰é˜Ÿåˆ—ã€‚CQèƒ½æœåŠ¡äºå‘é€é˜Ÿåˆ—ã€æ¥æ”¶é˜Ÿåˆ—æˆ–è€…åŒæ—¶æœåŠ¡äºè¿™ä¸¤ç§é˜Ÿåˆ—ã€‚å¤šä¸ªä¸åŒQPä¸­çš„å·¥ä½œè¯·æ±‚ï¼ˆWQï¼‰å¯è”ç³»åˆ°åŒä¸€ä¸ªCQä¸Šã€‚</p>

<h3 id="mrmemory-region">MR(Memory Region)</h3>

<p>å†…å­˜æ³¨å†Œæœºåˆ¶å…è®¸åº”ç”¨ç¨‹åºç”³è¯·ä¸€äº›è¿ç»­çš„è™šæ‹Ÿå†…å­˜ç©ºé—´æˆ–è€…è¿ç»­çš„ç‰©ç†å†…å­˜ç©ºé—´ï¼Œå°†è¿™äº›å†…å­˜ç©ºé—´æä¾›ç»™ç½‘ç»œé€‚é…å™¨ä½œä¸ºè™šæ‹Ÿçš„è¿ç»­ç¼“å†²åŒºï¼Œç¼“å†²åŒºä½¿ç”¨è™šæ‹Ÿåœ°å€ã€‚å†…å­˜æ³¨å†Œè¿›ç¨‹é”å®šäº†å†…å­˜é¡µã€‚ï¼ˆä¸ºäº†é˜²æ­¢é¡µè¢«æ›¿æ¢å‡ºå»ï¼ŒåŒæ—¶ä¿æŒç‰©ç†å’Œè™šæ‹Ÿå†…å­˜çš„æ˜ å°„ï¼‰åœ¨æ³¨å†ŒæœŸé—´ï¼Œæ“ä½œç³»ç»Ÿæ£€æŸ¥è¢«æ³¨å†Œå—çš„è®¸å¯ã€‚æ³¨å†Œè¿›ç¨‹å°†è™šæ‹Ÿåœ°å€ä¸ç‰©ç†åœ°å€çš„æ˜ å°„è¡¨å†™å…¥ç½‘ç»œé€‚é…å™¨ã€‚åœ¨æ³¨å†Œå†…å­˜æ—¶ï¼Œå¯¹åº”å†…å­˜åŒºåŸŸçš„æƒé™ä¼šè¢«è®¾å®šã€‚æƒé™åŒ…æ‹¬æœ¬åœ°å†™ã€è¿œç¨‹è¯»ã€è¿œç¨‹å†™ã€åŸå­æ“ä½œã€ç»‘å®šã€‚æ¯ä¸ªå†…å­˜æ³¨å†Œï¼ˆMRï¼‰æœ‰ä¸€ä¸ªè¿œç¨‹çš„å’Œä¸€ä¸ªæœ¬åœ°çš„æ ‡å¿—ï¼ˆr_keyï¼Œl_keyï¼‰ã€‚æœ¬åœ°æ ‡å¿—è¢«æœ¬åœ°çš„HCA ç”¨æ¥è®¿é—®æœ¬åœ°å†…å­˜ï¼Œä¾‹å¦‚åœ¨æ¥æ”¶æ•°æ®æ“ä½œçš„æœŸé—´ã€‚è¿œç¨‹æ ‡å¿—æä¾›ç»™è¿œç¨‹HCAç”¨æ¥åœ¨RDMAæ“ä½œæœŸé—´å…è®¸è¿œç¨‹è¿›ç¨‹è®¿é—®æœ¬åœ°çš„ç³»ç»Ÿå†…å­˜ã€‚åŒä¸€å†…å­˜ç¼“å†²åŒºå¯ä»¥è¢«å¤šæ¬¡æ³¨å†Œï¼ˆç”šè‡³è®¾ç½®ä¸åŒçš„æ“ä½œæƒé™ï¼‰ï¼Œå¹¶ä¸”æ¯æ¬¡æ³¨å†Œéƒ½ä¼šç”Ÿæˆä¸åŒçš„æ ‡å¿—ã€‚</p>

<h3 id="å‘é€è¯·æ±‚sr">å‘é€è¯·æ±‚ï¼ˆSRï¼‰</h3>

<p>SRå®šä¹‰äº†æ•°æ®çš„å‘é€é‡ã€ä»å“ªé‡Œã€å‘é€æ–¹å¼ã€æ˜¯å¦é€šè¿‡RDMAã€åˆ°å“ªé‡Œã€‚</p>

<p>RRå®šä¹‰ç”¨æ¥æ”¾ç½®é€šè¿‡éRDMAæ“ä½œæ¥æ”¶åˆ°çš„æ•°æ®çš„ç¼“å†²åŒºã€‚å¦‚æ²¡æœ‰å®šä¹‰ç¼“å†²åŒºï¼Œå¹¶ä¸”æœ‰ä¸ªä¼ è¾“è€… å°è¯•æ‰§è¡Œä¸€ä¸ªå‘é€æ“ä½œæˆ–è€…ä¸€ä¸ªå¸¦ç«‹å³æ•°çš„RDMAå†™æ“ä½œï¼Œé‚£ä¹ˆæ¥æ”¶è€…å°†ä¼šå‘å‡ºæ¥æ”¶æœªå°±ç»ªçš„é”™è¯¯ï¼ˆRNRï¼‰ã€‚</p>

<h3 id="æ¥æ”¶è¯·æ±‚rr">æ¥æ”¶è¯·æ±‚ï¼ˆRRï¼‰</h3>

<p>RRå®šä¹‰ç”¨æ¥æ”¾ç½®é€šè¿‡éRDMAæ“ä½œæ¥æ”¶åˆ°çš„æ•°æ®çš„ç¼“å†²åŒºã€‚å¦‚æ²¡æœ‰å®šä¹‰ç¼“å†²åŒºï¼Œå¹¶ä¸”æœ‰ä¸ªä¼ è¾“è€… å°è¯•æ‰§è¡Œä¸€ä¸ªå‘é€æ“ä½œæˆ–è€…ä¸€ä¸ªå¸¦ç«‹å³æ•°çš„RDMAå†™æ“ä½œï¼Œé‚£ä¹ˆæ¥æ”¶è€…å°†ä¼šå‘å‡ºæ¥æ”¶æœªå°±ç»ªçš„é”™è¯¯ï¼ˆRNRï¼‰ã€‚</p>

<h2 id="rdmaå·¥ä½œè¿‡ç¨‹">RDMAå·¥ä½œè¿‡ç¨‹</h2>

<ol>
  <li>å½“ä¸€ä¸ªåº”ç”¨æ‰§è¡ŒRDMA è¯»æˆ–å†™è¯·æ±‚æ—¶ï¼Œä¸æ‰§è¡Œä»»ä½•æ•°æ®å¤åˆ¶.åœ¨ä¸éœ€è¦ä»»ä½•å†…æ ¸å†…å­˜å‚ä¸çš„æ¡ä»¶ä¸‹ï¼ŒRDMA è¯·æ±‚ä»è¿è¡Œåœ¨ç”¨æˆ·ç©ºé—´ä¸­çš„åº”ç”¨ä¸­å‘é€åˆ°æœ¬åœ°NIC( ç½‘å¡)ã€‚</li>
  <li>NIC è¯»å–ç¼“å†²çš„å†…å®¹ï¼Œå¹¶é€šè¿‡ç½‘ç»œä¼ é€åˆ°è¿œç¨‹NICã€‚</li>
  <li>åœ¨ç½‘ç»œä¸Šä¼ è¾“çš„RDMA ä¿¡æ¯åŒ…å«ç›®æ ‡è™šæ‹Ÿåœ°å€ã€å†…å­˜é’¥åŒ™å’Œæ•°æ®æœ¬èº«.è¯·æ±‚æ—¢å¯ä»¥å®Œå…¨åœ¨ç”¨æˆ·ç©ºé—´ä¸­å¤„ç†(é€šè¿‡è½®è¯¢ç”¨æˆ·çº§å®Œæˆæ’åˆ—) ï¼Œåˆæˆ–è€…åœ¨åº”ç”¨ä¸€ç›´ç¡çœ åˆ°è¯·æ±‚å®Œæˆæ—¶çš„æƒ…å†µä¸‹é€šè¿‡ç³»ç»Ÿä¸­æ–­å¤„ç†.RDMA æ“ä½œä½¿åº”ç”¨å¯ä»¥ä»ä¸€ä¸ªè¿œç¨‹åº”ç”¨çš„å†…å­˜ä¸­è¯»æ•°æ®æˆ–å‘è¿™ä¸ªå†…å­˜å†™æ•°æ®ã€‚</li>
  <li>ç›®æ ‡NIC ç¡®è®¤å†…å­˜é’¥åŒ™ï¼Œç›´æ¥å°†æ•°æ®å†™äººåº”ç”¨ç¼“å­˜ä¸­.ç”¨äºæ“ä½œçš„è¿œç¨‹è™šæ‹Ÿå†…å­˜åœ°å€åŒ…å«åœ¨RDMA ä¿¡æ¯ä¸­ã€‚</li>
</ol>

<h2 id="reviewtcpé€šä¿¡æµç¨‹">Reviewï¼šTCPé€šä¿¡æµç¨‹</h2>

<h3 id="server">Server</h3>

<ol>
  <li>è°ƒç”¨<code class="highlighter-rouge">socket()</code>åˆ›å»ºä¸€ä¸ªå¥—æ¥å­—</li>
  <li>è°ƒç”¨<code class="highlighter-rouge">bind()</code>ç»‘å®šåˆ°ä¸€ä¸ªç«¯å£</li>
  <li>è°ƒç”¨<code class="highlighter-rouge">listen()</code>ç›‘å¬è¯¥ç«¯å£</li>
  <li>è°ƒç”¨<code class="highlighter-rouge">accept()</code>ç­‰å¾…å®¢æˆ·ç«¯è¿æ¥ä¸Šæ¥(é˜»å¡)</li>
  <li>å»ºç«‹TCPè¿æ¥</li>
  <li>è°ƒç”¨<code class="highlighter-rouge">send()</code>/<code class="highlighter-rouge">receive()</code>é€šè¿‡è¯¥è¿æ¥è¿›è¡Œé€šä¿¡</li>
</ol>

<h3 id="client">Client</h3>

<ol>
  <li>è°ƒç”¨<code class="highlighter-rouge">socket()</code>åˆ›å»ºä¸€ä¸ªå¥—æ¥å­—</li>
  <li>è°ƒç”¨<code class="highlighter-rouge">connect()</code>è¿ä¸ŠæœåŠ¡ç«¯</li>
  <li>å»ºç«‹TCPè¿æ¥</li>
  <li>è°ƒç”¨<code class="highlighter-rouge">send()</code>/<code class="highlighter-rouge">receive()</code>é€šè¿‡è¯¥è¿æ¥è¿›è¡Œé€šä¿¡</li>
</ol>

<h2 id="rdmaé€šä¿¡æµç¨‹">RDMAé€šä¿¡æµç¨‹</h2>

<h3 id="è·å–rdmaè®¾å¤‡åˆ—è¡¨ibv_get_device_list">è·å–RDMAè®¾å¤‡åˆ—è¡¨ï¼ˆ<code class="highlighter-rouge">ibv_get_device_list</code>ï¼‰</h3>

<p>è·å¾—æœºå™¨ä¸Šçš„RDMAè®¾å¤‡ã€‚æœ‰ç‚¹åƒCUDAã€‚</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="cm">/* 1 è·å–è®¾å¤‡åˆ—è¡¨ */</span>
	<span class="kt">int</span> <span class="n">num_devices</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ibv_device</span> <span class="o">**</span><span class="n">dev_list</span> <span class="o">=</span> <span class="n">ibv_get_device_list</span><span class="p">(</span><span class="o">&amp;</span><span class="n">num_devices</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev_list</span> <span class="o">||</span> <span class="o">!</span><span class="n">num_devices</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"failed to get IB devices</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">main_exit</span><span class="p">;</span>
	<span class="p">}</span>
</code></pre></div></div>

<h3 id="æ‰“å¼€ä¸€ä¸ªrdmaè®¾å¤‡è·å–ä¸€ä¸ªä¸Šä¸‹æ–‡ibv_open_deviceibv_context">æ‰“å¼€ä¸€ä¸ªRDMAè®¾å¤‡ï¼Œè·å–ä¸€ä¸ªä¸Šä¸‹æ–‡ï¼ˆibv_open_deviceã€ibv_contextï¼‰</h3>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="cm">/* 2 æ‰“å¼€è®¾å¤‡ï¼Œè·å–è®¾å¤‡ä¸Šä¸‹æ–‡ */</span>
	<span class="k">struct</span> <span class="n">ibv_device</span> <span class="o">*</span><span class="n">ib_dev</span> <span class="o">=</span> <span class="n">dev_list</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">res</span><span class="p">.</span><span class="n">ib_ctx</span> <span class="o">=</span> <span class="n">ibv_open_device</span><span class="p">(</span><span class="n">ib_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">.</span><span class="n">ib_ctx</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"failed to open device </span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">main_exit</span><span class="p">;</span>
	<span class="p">}</span>
</code></pre></div></div>

<h3 id="é‡Šæ”¾rdmaè®¾å¤‡åˆ—è¡¨å ç”¨çš„èµ„æºibv_free_device_list">é‡Šæ”¾RDMAè®¾å¤‡åˆ—è¡¨å ç”¨çš„èµ„æºï¼ˆibv_free_device_listï¼‰</h3>

<p>ä¸ªäººç†è§£è¿™ä¸€æ­¥æ˜¯åœ¨ç»™å‰ä¸¤æ­¥æ“¦å±è‚¡â€¦å› ä¸ºé€šå¸¸éœ€è¦æ“ä½œçš„æ˜¯å•ä¸ªRDMAè®¾å¤‡ï¼Œè€Œç¬¬ä¸€æ­¥è·å¾—çš„æ˜¯ä¸€ä¸ªåˆ—è¡¨ã€‚å¤šä½™çš„éƒ¨åˆ†è‡ªç„¶æ˜¯è¦é‡Šæ”¾æ‰ã€‚</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="cm">/* 3 é‡Šæ”¾è®¾å¤‡åˆ—è¡¨å ç”¨çš„èµ„æº */</span>
	<span class="n">ibv_free_device_list</span><span class="p">(</span><span class="n">dev_list</span><span class="p">);</span>
	<span class="n">dev_list</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ib_dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</code></pre></div></div>

<h3 id="æŸ¥è¯¢rdmaè®¾å¤‡ç«¯å£ä¿¡æ¯ibv_query_portibv_port_attr">æŸ¥è¯¢RDMAè®¾å¤‡ç«¯å£ä¿¡æ¯ï¼ˆibv_query_portã€ibv_port_attrï¼‰</h3>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="cm">/* 4 æŸ¥è¯¢è®¾å¤‡ç«¯å£çŠ¶æ€ */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ibv_query_port</span><span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">ib_ctx</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">.</span><span class="n">port_attr</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"ibv_query_port on port failed</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">main_exit</span><span class="p">;</span>
	<span class="p">}</span>
</code></pre></div></div>

<h3 id="åˆ†é…ä¸€ä¸ªprotection-domainibv_alloc_pdibv_pd">åˆ†é…ä¸€ä¸ªProtection Domainï¼ˆibv_alloc_pdã€ibv_pdï¼‰</h3>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="cm">/* 5 åˆ›å»ºPDï¼ˆProtection Domainï¼‰ */</span>
	<span class="n">res</span><span class="p">.</span><span class="n">pd</span> <span class="o">=</span> <span class="n">ibv_alloc_pd</span><span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">ib_ctx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">.</span><span class="n">pd</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"ibv_alloc_pd failed</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">main_exit</span><span class="p">;</span>
	<span class="p">}</span>
</code></pre></div></div>

<h3 id="åˆ›å»ºä¸€ä¸ªcomplete-queueibv_create_cqibv_cq">åˆ›å»ºä¸€ä¸ªComplete Queueï¼ˆibv_create_cqã€ibv_cqï¼‰</h3>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="cm">/* 6 åˆ›å»ºCQï¼ˆComplete Queueï¼‰ */</span>
	<span class="kt">int</span> <span class="n">cq_size</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
	<span class="n">res</span><span class="p">.</span><span class="n">cq</span> <span class="o">=</span> <span class="n">ibv_create_cq</span><span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">ib_ctx</span><span class="p">,</span> <span class="n">cq_size</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">.</span><span class="n">cq</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"failed to create CQ with %u entries</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">cq_size</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">main_exit</span><span class="p">;</span>
	<span class="p">}</span>
</code></pre></div></div>

<h3 id="æ³¨å†Œä¸€å—memory-regionibv_reg_mribv_mr">æ³¨å†Œä¸€å—Memory Regionï¼ˆibv_reg_mrã€ibv_mrï¼‰</h3>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="cm">/* 7 æ³¨å†ŒMRï¼ˆMemory Regionï¼‰ */</span>
	<span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">MSG_SIZE</span><span class="p">;</span>
	<span class="n">res</span><span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">.</span><span class="n">buf</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"failed to malloc %Zu bytes to memory buffer</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">main_exit</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

	<span class="kt">int</span> <span class="n">mr_flags</span> <span class="o">=</span> <span class="n">IBV_ACCESS_LOCAL_WRITE</span> <span class="o">|</span> <span class="n">IBV_ACCESS_REMOTE_READ</span> <span class="o">|</span> <span class="n">IBV_ACCESS_REMOTE_WRITE</span><span class="p">;</span>
	<span class="n">res</span><span class="p">.</span><span class="n">mr</span> <span class="o">=</span> <span class="n">ibv_reg_mr</span><span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">pd</span><span class="p">,</span> <span class="n">res</span><span class="p">.</span><span class="n">buf</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">mr_flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">.</span><span class="n">mr</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"ibv_reg_mr failed with mr_flags=0x%x</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">mr_flags</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">main_exit</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">"MR was registered with addr=%p, lkey=0x%x, rkey=0x%x, flags=0x%x</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
			<span class="n">res</span><span class="p">.</span><span class="n">buf</span><span class="p">,</span> <span class="n">res</span><span class="p">.</span><span class="n">mr</span><span class="o">-&gt;</span><span class="n">lkey</span><span class="p">,</span> <span class="n">res</span><span class="p">.</span><span class="n">mr</span><span class="o">-&gt;</span><span class="n">rkey</span><span class="p">,</span> <span class="n">mr_flags</span><span class="p">);</span>
</code></pre></div></div>

<h3 id="åˆ›å»ºä¸€ä¸ªqueue-pairibv_create_qpibv_qp">åˆ›å»ºä¸€ä¸ªQueue Pairï¼ˆibv_create_qpã€ibv_qpï¼‰</h3>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="cm">/* 8 åˆ›å»ºQPï¼ˆQueue Pairï¼‰ */</span>
	<span class="k">struct</span> <span class="n">ibv_qp_init_attr</span> <span class="n">qp_init_attr</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qp_init_attr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">qp_init_attr</span><span class="p">));</span>
	<span class="n">qp_init_attr</span><span class="p">.</span><span class="n">qp_type</span> <span class="o">=</span> <span class="n">IBV_QPT_RC</span><span class="p">;</span>
	<span class="n">qp_init_attr</span><span class="p">.</span><span class="n">sq_sig_all</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">qp_init_attr</span><span class="p">.</span><span class="n">send_cq</span> <span class="o">=</span> <span class="n">res</span><span class="p">.</span><span class="n">cq</span><span class="p">;</span>
	<span class="n">qp_init_attr</span><span class="p">.</span><span class="n">recv_cq</span> <span class="o">=</span> <span class="n">res</span><span class="p">.</span><span class="n">cq</span><span class="p">;</span>
	<span class="n">qp_init_attr</span><span class="p">.</span><span class="n">cap</span><span class="p">.</span><span class="n">max_send_wr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">qp_init_attr</span><span class="p">.</span><span class="n">cap</span><span class="p">.</span><span class="n">max_recv_wr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">qp_init_attr</span><span class="p">.</span><span class="n">cap</span><span class="p">.</span><span class="n">max_send_sge</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">qp_init_attr</span><span class="p">.</span><span class="n">cap</span><span class="p">.</span><span class="n">max_recv_sge</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">res</span><span class="p">.</span><span class="n">qp</span> <span class="o">=</span> <span class="n">ibv_create_qp</span><span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">pd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qp_init_attr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">.</span><span class="n">qp</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"failed to create QP</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">main_exit</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">"QP was created, QP number=0x%x</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">res</span><span class="p">.</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">qp_num</span><span class="p">);</span>
</code></pre></div></div>

<h3 id="äº¤æ¢æ§åˆ¶ä¿¡æ¯ä½¿ç”¨socketæˆ–rdma_cm-api">äº¤æ¢æ§åˆ¶ä¿¡æ¯ï¼ˆä½¿ç”¨Socketæˆ–RDMA_CM APIï¼‰</h3>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="cm">/* 9 äº¤æ¢æ§åˆ¶ä¿¡æ¯ */</span>
	<span class="k">struct</span> <span class="n">cm_con_data_t</span> <span class="n">local_con_data</span><span class="p">;</span>  <span class="c1">// å‘é€ç»™è¿œç¨‹ä¸»æœºçš„ä¿¡æ¯</span>
	<span class="k">struct</span> <span class="n">cm_con_data_t</span> <span class="n">remote_con_data</span><span class="p">;</span> <span class="c1">// æ¥æ”¶è¿œç¨‹ä¸»æœºå‘é€è¿‡æ¥çš„ä¿¡æ¯</span>
	<span class="k">struct</span> <span class="n">cm_con_data_t</span> <span class="n">tmp_con_data</span><span class="p">;</span>

	<span class="n">local_con_data</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">htonll</span><span class="p">((</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="n">res</span><span class="p">.</span><span class="n">buf</span><span class="p">);</span>
	<span class="n">local_con_data</span><span class="p">.</span><span class="n">rkey</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">mr</span><span class="o">-&gt;</span><span class="n">rkey</span><span class="p">);</span>
	<span class="n">local_con_data</span><span class="p">.</span><span class="n">qp_num</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">qp_num</span><span class="p">);</span>
	<span class="n">local_con_data</span><span class="p">.</span><span class="n">lid</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">port_attr</span><span class="p">.</span><span class="n">lid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sock_sync_data</span><span class="p">(</span><span class="n">server_ip</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cm_con_data_t</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">local_con_data</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">tmp_con_data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"failed to exchange connection data between sides</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">main_exit</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">remote_con_data</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">ntohll</span><span class="p">(</span><span class="n">tmp_con_data</span><span class="p">.</span><span class="n">addr</span><span class="p">);</span>
	<span class="n">remote_con_data</span><span class="p">.</span><span class="n">rkey</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">tmp_con_data</span><span class="p">.</span><span class="n">rkey</span><span class="p">);</span>
	<span class="n">remote_con_data</span><span class="p">.</span><span class="n">qp_num</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">tmp_con_data</span><span class="p">.</span><span class="n">qp_num</span><span class="p">);</span>
	<span class="n">remote_con_data</span><span class="p">.</span><span class="n">lid</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">tmp_con_data</span><span class="p">.</span><span class="n">lid</span><span class="p">);</span>
	<span class="cm">/* save the remote side attributes, we will need it for the post SR */</span>
	<span class="n">res</span><span class="p">.</span><span class="n">remote_props</span> <span class="o">=</span> <span class="n">remote_con_data</span><span class="p">;</span>
	<span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">"Remote address = 0x%"</span> <span class="n">PRIx64</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">remote_con_data</span><span class="p">.</span><span class="n">addr</span><span class="p">);</span>
	<span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">"Remote rkey = 0x%x</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">remote_con_data</span><span class="p">.</span><span class="n">rkey</span><span class="p">);</span>
	<span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">"Remote QP number = 0x%x</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">remote_con_data</span><span class="p">.</span><span class="n">qp_num</span><span class="p">);</span>
	<span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">"Remote LID = 0x%x</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">remote_con_data</span><span class="p">.</span><span class="n">lid</span><span class="p">);</span>
</code></pre></div></div>

<h3 id="è½¬æ¢qpçŠ¶æ€reset-init-rtr-rtsibv_modify_qp">è½¬æ¢QPçŠ¶æ€RESET-&gt;INIT-&gt;RTR-&gt;RTSï¼ˆibv_modify_qpï¼‰</h3>

<ul>
  <li>çŠ¶æ€ï¼šRESET -&gt; INIT -&gt; RTR -&gt; RTS</li>
  <li>è¦ä¸¥æ ¼æŒ‰ç…§é¡ºåºè¿›è¡Œè½¬æ¢</li>
  <li>QPåˆšåˆ›å»ºæ—¶çŠ¶æ€ä¸ºRESET</li>
  <li>INITä¹‹åå°±å¯ä»¥è°ƒç”¨ibv_post_recvæäº¤ä¸€ä¸ªreceive bufferäº†</li>
  <li>å½“ QPè¿›å…¥RTR(ready to receive)çŠ¶æ€ä»¥åï¼Œä¾¿å¼€å§‹è¿›è¡Œæ¥æ”¶å¤„ç†</li>
  <li>RTRä¹‹åä¾¿å¯ä»¥è½¬ä¸ºRTS(ready to send)ï¼ŒRTSçŠ¶æ€ä¸‹å¯ä»¥è°ƒç”¨ibv_post_send</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="cm">/* 10 è½¬æ¢QPçŠ¶æ€ */</span>
	<span class="c1">// RESET -&gt; INIT</span>
	<span class="k">struct</span> <span class="n">ibv_qp_attr</span> <span class="n">attr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">attr</span><span class="p">));</span>
	<span class="n">attr</span><span class="p">.</span><span class="n">qp_state</span> <span class="o">=</span> <span class="n">IBV_QPS_INIT</span><span class="p">;</span>
	<span class="n">attr</span><span class="p">.</span><span class="n">port_num</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// IB ç«¯å£å·</span>
	<span class="n">attr</span><span class="p">.</span><span class="n">pkey_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">attr</span><span class="p">.</span><span class="n">qp_access_flags</span> <span class="o">=</span> <span class="n">IBV_ACCESS_LOCAL_WRITE</span> <span class="o">|</span> <span class="n">IBV_ACCESS_REMOTE_READ</span> <span class="o">|</span> <span class="n">IBV_ACCESS_REMOTE_WRITE</span><span class="p">;</span>
	<span class="n">flags</span> <span class="o">=</span> <span class="n">IBV_QP_STATE</span> <span class="o">|</span> <span class="n">IBV_QP_PKEY_INDEX</span> <span class="o">|</span> <span class="n">IBV_QP_PORT</span> <span class="o">|</span> <span class="n">IBV_QP_ACCESS_FLAGS</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ibv_modify_qp</span><span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">qp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"failed to modify QP state to INIT</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>

	<span class="c1">//INIT -&gt; RTR(Ready To Receive)</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">attr</span><span class="p">));</span>
	<span class="n">attr</span><span class="p">.</span><span class="n">qp_state</span> <span class="o">=</span> <span class="n">IBV_QPS_RTR</span><span class="p">;</span>
	<span class="n">attr</span><span class="p">.</span><span class="n">path_mtu</span> <span class="o">=</span> <span class="n">IBV_MTU_256</span><span class="p">;</span>
	<span class="n">attr</span><span class="p">.</span><span class="n">dest_qp_num</span> <span class="o">=</span> <span class="n">res</span><span class="p">.</span><span class="n">remote_props</span><span class="p">.</span><span class="n">qp_num</span><span class="p">;</span>
	<span class="n">attr</span><span class="p">.</span><span class="n">rq_psn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">attr</span><span class="p">.</span><span class="n">max_dest_rd_atomic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">attr</span><span class="p">.</span><span class="n">min_rnr_timer</span> <span class="o">=</span> <span class="mh">0x12</span><span class="p">;</span>
	<span class="n">attr</span><span class="p">.</span><span class="n">ah_attr</span><span class="p">.</span><span class="n">is_global</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">attr</span><span class="p">.</span><span class="n">ah_attr</span><span class="p">.</span><span class="n">dlid</span> <span class="o">=</span> <span class="n">res</span><span class="p">.</span><span class="n">remote_props</span><span class="p">.</span><span class="n">lid</span><span class="p">;</span>
	<span class="n">attr</span><span class="p">.</span><span class="n">ah_attr</span><span class="p">.</span><span class="n">sl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">attr</span><span class="p">.</span><span class="n">ah_attr</span><span class="p">.</span><span class="n">src_path_bits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">attr</span><span class="p">.</span><span class="n">ah_attr</span><span class="p">.</span><span class="n">port_num</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">flags</span> <span class="o">=</span> <span class="n">IBV_QP_STATE</span> <span class="o">|</span> <span class="n">IBV_QP_AV</span> <span class="o">|</span> <span class="n">IBV_QP_PATH_MTU</span> <span class="o">|</span> <span class="n">IBV_QP_DEST_QPN</span> <span class="o">|</span> <span class="n">IBV_QP_RQ_PSN</span> <span class="o">|</span> <span class="n">IBV_QP_MAX_DEST_RD_ATOMIC</span> <span class="o">|</span> <span class="n">IBV_QP_MIN_RNR_TIMER</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ibv_modify_qp</span><span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">qp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"failed to modify QP state to RTR</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>

	<span class="c1">//RTR -&gt; RTS(Ready To Send)</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">attr</span><span class="p">));</span>
	<span class="n">attr</span><span class="p">.</span><span class="n">qp_state</span> <span class="o">=</span> <span class="n">IBV_QPS_RTS</span><span class="p">;</span>
	<span class="n">attr</span><span class="p">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="mh">0x12</span><span class="p">;</span>
	<span class="n">attr</span><span class="p">.</span><span class="n">retry_cnt</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
	<span class="n">attr</span><span class="p">.</span><span class="n">rnr_retry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">attr</span><span class="p">.</span><span class="n">sq_psn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">attr</span><span class="p">.</span><span class="n">max_rd_atomic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">flags</span> <span class="o">=</span> <span class="n">IBV_QP_STATE</span> <span class="o">|</span> <span class="n">IBV_QP_TIMEOUT</span> <span class="o">|</span> <span class="n">IBV_QP_RETRY_CNT</span> <span class="o">|</span> <span class="n">IBV_QP_RNR_RETRY</span> <span class="o">|</span> <span class="n">IBV_QP_SQ_PSN</span> <span class="o">|</span> <span class="n">IBV_QP_MAX_QP_RD_ATOMIC</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ibv_modify_qp</span><span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">qp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"failed to modify QP state to RTS</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
</code></pre></div></div>

<h3 id="åˆ›å»ºå‘é€ä»»åŠ¡æ¥æ”¶ä»»åŠ¡ibv_send_wr--ibv_recv_wr">åˆ›å»ºå‘é€ä»»åŠ¡/æ¥æ”¶ä»»åŠ¡ï¼ˆibv_send_wr / ibv_recv_wrï¼‰</h3>

<ul>
  <li>ibv_send_wrï¼ˆsend work requestï¼‰</li>
  <li>è¯¥ä»»åŠ¡ä¼šè¢«æäº¤åˆ°QPä¸­çš„SQï¼ˆSend Queueï¼‰ä¸­</li>
  <li>å‘é€ä»»åŠ¡æœ‰ä¸‰ç§æ“ä½œï¼šSend,Read,Write</li>
  <li>Sendæ“ä½œéœ€è¦å¯¹æ–¹æ‰§è¡Œç›¸åº”çš„Receiveæ“ä½œ</li>
  <li>Read/Writeç›´æ¥æ“ä½œå¯¹æ–¹å†…å­˜ï¼Œå¯¹æ–¹æ— æ„ŸçŸ¥</li>
  <li>æŠŠè¦å‘é€çš„æ•°æ®çš„å†…å­˜åœ°å€ï¼Œå¤§å°ï¼Œå¯†é’¥å‘Šè¯‰HCA</li>
  <li>Read/Writeè¿˜éœ€è¦å‘Šè¯‰HCAè¿œç¨‹çš„å†…å­˜åœ°å€å’Œå¯†é’¥</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="cm">/* 11 åˆ›å»ºå‘é€ä»»åŠ¡ibv_send_wr */</span>
	<span class="k">struct</span> <span class="n">ibv_send_wr</span> <span class="n">sr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ibv_sge</span> <span class="n">sge</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ibv_send_wr</span> <span class="o">*</span><span class="n">bad_wr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="cm">/* prepare the scatter/gather entry */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sge</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sge</span><span class="p">));</span>
	<span class="n">sge</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">;</span>
	<span class="n">sge</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">MSG_SIZE</span><span class="p">;</span>
	<span class="n">sge</span><span class="p">.</span><span class="n">lkey</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">mr</span><span class="o">-&gt;</span><span class="n">lkey</span><span class="p">;</span>
	<span class="cm">/* prepare the send work request */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sr</span><span class="p">));</span>
	<span class="n">sr</span><span class="p">.</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">sr</span><span class="p">.</span><span class="n">wr_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sr</span><span class="p">.</span><span class="n">sg_list</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sge</span><span class="p">;</span>
	<span class="n">sr</span><span class="p">.</span><span class="n">num_sge</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">sr</span><span class="p">.</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">opcode</span><span class="p">;</span>
	<span class="n">sr</span><span class="p">.</span><span class="n">send_flags</span> <span class="o">=</span> <span class="n">IBV_SEND_SIGNALED</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">opcode</span> <span class="o">!=</span> <span class="n">IBV_WR_SEND</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">sr</span><span class="p">.</span><span class="n">wr</span><span class="p">.</span><span class="n">rdma</span><span class="p">.</span><span class="n">remote_addr</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">remote_props</span><span class="p">.</span><span class="n">addr</span><span class="p">;</span>
		<span class="n">sr</span><span class="p">.</span><span class="n">wr</span><span class="p">.</span><span class="n">rdma</span><span class="p">.</span><span class="n">rkey</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">remote_props</span><span class="p">.</span><span class="n">rkey</span><span class="p">;</span>
	<span class="p">}</span>
</code></pre></div></div>

<h3 id="æäº¤å‘é€ä»»åŠ¡æ¥æ”¶ä»»åŠ¡ibv_post_send--ibv_post_recv">æäº¤å‘é€ä»»åŠ¡/æ¥æ”¶ä»»åŠ¡ï¼ˆibv_post_send / ibv_post_recvï¼‰</h3>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="n">rc</span> <span class="o">=</span> <span class="n">ibv_post_send</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bad_wr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"failed to post SR</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
</code></pre></div></div>

<h3 id="è½®è¯¢ä»»åŠ¡å®Œæˆä¿¡æ¯ibv_poll_cq">è½®è¯¢ä»»åŠ¡å®Œæˆä¿¡æ¯ï¼ˆibv_poll_cqï¼‰</h3>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="cm">/* 13 è½®è¯¢ä»»åŠ¡ç»“æœ */</span>
	<span class="k">struct</span> <span class="n">ibv_wc</span> <span class="n">wc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">poll_result</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">do</span>
	<span class="p">{</span>
		<span class="n">poll_result</span> <span class="o">=</span> <span class="n">ibv_poll_cq</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">cq</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wc</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">poll_result</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
</code></pre></div></div>

<h2 id="å®Œæ•´ç¤ºä¾‹ä»£ç rdma_read_write_democ">å®Œæ•´ç¤ºä¾‹ä»£ç ï¼ˆ<code class="highlighter-rouge">RDMA_Read_Write_Demo.c</code>ï¼‰</h2>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/*
* BUILD COMMAND:
* gcc -Wall  -o RDMA_Read_Write_Demo   RDMA_Read_Write_Demo.c -libverbs
*/</span>
<span class="cm">/******************************************************************************
*
* RDMA Aware Networks Programming Example
*
* This code demonstrates how to perform the following operations using the * VPI Verbs API:
*
* Send
* Receive
* RDMA Read
* RDMA Write
*
*****************************************************************************/</span>

<span class="cp">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;
#include &lt;unistd.h&gt;
#include &lt;stdint.h&gt;
#include &lt;inttypes.h&gt;
#include &lt;endian.h&gt;
#include &lt;byteswap.h&gt;
#include &lt;getopt.h&gt;
</span>
<span class="cp">#include &lt;sys/time.h&gt;
#include &lt;arpa/inet.h&gt;
#include &lt;infiniband/verbs.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;sys/socket.h&gt;
#include &lt;netdb.h&gt;
</span>
<span class="cm">/* poll CQ timeout in millisec (2 seconds) */</span>
<span class="cp">#define MAX_POLL_CQ_TIMEOUT 20000
#define MSG "SEND operation "
#define MSG_SIZE 1048576 //1MB
#if __BYTE_ORDER == __LITTLE_ENDIAN
</span><span class="k">static</span> <span class="kr">inline</span> <span class="kt">uint64_t</span> <span class="nf">htonll</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">x</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">bswap_64</span><span class="p">(</span><span class="n">x</span><span class="p">);</span> <span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">uint64_t</span> <span class="nf">ntohll</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">x</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">bswap_64</span><span class="p">(</span><span class="n">x</span><span class="p">);</span> <span class="p">}</span>
<span class="cp">#elif __BYTE_ORDER == __BIG_ENDIAN
</span><span class="k">static</span> <span class="kr">inline</span> <span class="kt">uint64_t</span> <span class="nf">htonll</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">x</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">x</span><span class="p">;</span> <span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">uint64_t</span> <span class="nf">ntohll</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">x</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">x</span><span class="p">;</span> <span class="p">}</span>
<span class="cp">#else
#error __BYTE_ORDER is neither __LITTLE_ENDIAN nor __BIG_ENDIAN
#endif
</span>
<span class="cm">/* structure to exchange data which is needed to connect the QPs */</span>
<span class="k">struct</span> <span class="n">cm_con_data_t</span>
<span class="p">{</span>
	<span class="kt">uint64_t</span> <span class="n">addr</span><span class="p">;</span>   <span class="cm">/* Buffer address */</span>
	<span class="kt">uint32_t</span> <span class="n">rkey</span><span class="p">;</span>   <span class="cm">/* Remote key */</span>
	<span class="kt">uint32_t</span> <span class="n">qp_num</span><span class="p">;</span> <span class="cm">/* QP number */</span>
	<span class="kt">uint16_t</span> <span class="n">lid</span><span class="p">;</span>	<span class="cm">/* LID of the IB port */</span>
<span class="p">}</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="cm">/* structure of system resources */</span>
<span class="k">struct</span> <span class="n">resources</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ibv_device_attr</span> <span class="n">device_attr</span><span class="p">;</span> <span class="cm">/* Device attributes */</span>
	<span class="k">struct</span> <span class="n">ibv_port_attr</span> <span class="n">port_attr</span><span class="p">;</span>		<span class="cm">/* IB port attributes */</span>
	<span class="k">struct</span> <span class="n">cm_con_data_t</span> <span class="n">remote_props</span><span class="p">;</span>  <span class="cm">/* values to connect to remote side */</span>
	<span class="k">struct</span> <span class="n">ibv_context</span> <span class="o">*</span><span class="n">ib_ctx</span><span class="p">;</span>			<span class="cm">/* device handle */</span>
	<span class="k">struct</span> <span class="n">ibv_pd</span> <span class="o">*</span><span class="n">pd</span><span class="p">;</span>					<span class="cm">/* PD handle */</span>
	<span class="k">struct</span> <span class="n">ibv_cq</span> <span class="o">*</span><span class="n">cq</span><span class="p">;</span>					<span class="cm">/* CQ handle */</span>
	<span class="k">struct</span> <span class="n">ibv_qp</span> <span class="o">*</span><span class="n">qp</span><span class="p">;</span>					<span class="cm">/* QP handle */</span>
	<span class="k">struct</span> <span class="n">ibv_mr</span> <span class="o">*</span><span class="n">mr</span><span class="p">;</span>					<span class="cm">/* MR handle for buf */</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>							<span class="cm">/* memory buffer pointer */</span>
<span class="p">};</span>

<span class="cm">/******************************************************************************
* Function: sock_connect
*
* Input
* servername URL of server to connect to (NULL for server mode)
* port port of service
*
* Output
* none
*
* Returns
* socket (fd) on success, negative error code on failure
*
* Description
* Connect a socket. If servername is specified a client connection will be
* initiated to the indicated server and port. Otherwise listen on the
* indicated port for an incoming connection.
*
******************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sock_connect</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">servername</span><span class="p">,</span> <span class="kt">int</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">addrinfo</span> <span class="o">*</span><span class="n">resolved_addr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">addrinfo</span> <span class="o">*</span><span class="n">iterator</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">service</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">sockfd</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">listenfd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">addrinfo</span> <span class="n">hints</span> <span class="o">=</span>
		<span class="p">{</span>
			<span class="p">.</span><span class="n">ai_flags</span> <span class="o">=</span> <span class="n">AI_PASSIVE</span><span class="p">,</span>
			<span class="p">.</span><span class="n">ai_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">,</span>
			<span class="p">.</span><span class="n">ai_socktype</span> <span class="o">=</span> <span class="n">SOCK_STREAM</span><span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sprintf</span><span class="p">(</span><span class="n">service</span><span class="p">,</span> <span class="s">"%d"</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">sock_connect_exit</span><span class="p">;</span>
	<span class="cm">/* Resolve DNS address, use sockfd as temp storage */</span>
	<span class="n">sockfd</span> <span class="o">=</span> <span class="n">getaddrinfo</span><span class="p">(</span><span class="n">servername</span><span class="p">,</span> <span class="n">service</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hints</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">resolved_addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sockfd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"%s for %s:%d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">gai_strerror</span><span class="p">(</span><span class="n">sockfd</span><span class="p">),</span> <span class="n">servername</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">sock_connect_exit</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Search through results and find the one we want */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">iterator</span> <span class="o">=</span> <span class="n">resolved_addr</span><span class="p">;</span> <span class="n">iterator</span><span class="p">;</span> <span class="n">iterator</span> <span class="o">=</span> <span class="n">iterator</span><span class="o">-&gt;</span><span class="n">ai_next</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">sockfd</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">iterator</span><span class="o">-&gt;</span><span class="n">ai_family</span><span class="p">,</span> <span class="n">iterator</span><span class="o">-&gt;</span><span class="n">ai_socktype</span><span class="p">,</span> <span class="n">iterator</span><span class="o">-&gt;</span><span class="n">ai_protocol</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sockfd</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">servername</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="cm">/* Client mode. Initiate connection to remote */</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">=</span> <span class="n">connect</span><span class="p">(</span><span class="n">sockfd</span><span class="p">,</span> <span class="n">iterator</span><span class="o">-&gt;</span><span class="n">ai_addr</span><span class="p">,</span> <span class="n">iterator</span><span class="o">-&gt;</span><span class="n">ai_addrlen</span><span class="p">)))</span>
				<span class="p">{</span>
					<span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">"failed connect </span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
					<span class="n">close</span><span class="p">(</span><span class="n">sockfd</span><span class="p">);</span>
					<span class="n">sockfd</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">else</span>
			<span class="p">{</span>
				<span class="cm">/* Server mode. Set up listening socket an accept a connection */</span>
				<span class="n">listenfd</span> <span class="o">=</span> <span class="n">sockfd</span><span class="p">;</span>
				<span class="n">sockfd</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">bind</span><span class="p">(</span><span class="n">listenfd</span><span class="p">,</span> <span class="n">iterator</span><span class="o">-&gt;</span><span class="n">ai_addr</span><span class="p">,</span> <span class="n">iterator</span><span class="o">-&gt;</span><span class="n">ai_addrlen</span><span class="p">))</span>
					<span class="k">goto</span> <span class="n">sock_connect_exit</span><span class="p">;</span>
				<span class="n">listen</span><span class="p">(</span><span class="n">listenfd</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">sockfd</span> <span class="o">=</span> <span class="n">accept</span><span class="p">(</span><span class="n">listenfd</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="nl">sock_connect_exit:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">listenfd</span><span class="p">)</span>
		<span class="n">close</span><span class="p">(</span><span class="n">listenfd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">resolved_addr</span><span class="p">)</span>
		<span class="n">freeaddrinfo</span><span class="p">(</span><span class="n">resolved_addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sockfd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">servername</span><span class="p">)</span>
			<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"Couldn't connect to %s:%d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">servername</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
		<span class="k">else</span>
		<span class="p">{</span>
			<span class="n">perror</span><span class="p">(</span><span class="s">"server accept"</span><span class="p">);</span>
			<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"accept() failed</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">sockfd</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/******************************************************************************
* Function: sock_sync_data
*
* Input
Table 5 -
* sock socket to transfer data on
* xfer_size size of data to transfer
* local_data pointer to data to be sent to remote (local_dataæ˜¯ä¸€ä¸ªæŒ‡å‘è¦å‘é€åˆ°è¿œç¨‹çš„æ•°æ®çš„æŒ‡é’ˆ)
*
* Output
* remote_data pointer to buffer to receive remote data
*
* Returns
* 0 on success, negative error code on failure
*
* Description
* Sync data across a socket. The indicated local data will be sent to the
* remote. It will then wait for the remote to send its data back. It is
* assumed that the two sides are in sync and call this function in the proper
* order. Chaos will ensue if they are not. :)
*
* Also note this is a blocking function and will wait for the full data to be
* received from the remote.
*
******************************************************************************/</span>
<span class="kt">int</span> <span class="nf">sock_sync_data</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">server_ip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">xfer_size</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">local_data</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">remote_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">sock</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="mi">10002</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">server_ip</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">sock</span> <span class="o">=</span> <span class="n">sock_connect</span><span class="p">(</span><span class="n">server_ip</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sock</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"failed to establish TCP connection to server %s, port %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
					<span class="n">server_ip</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">"waiting on port %d for TCP connection</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
		<span class="n">sock</span> <span class="o">=</span> <span class="n">sock_connect</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sock</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"failed to establish TCP connection with client</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">"TCP connection was established</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">read_bytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">total_read_bytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">write</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">local_data</span><span class="p">,</span> <span class="n">xfer_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="n">xfer_size</span><span class="p">)</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"Failed writing data during sock_sync_data</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span> <span class="o">&amp;&amp;</span> <span class="n">total_read_bytes</span> <span class="o">&lt;</span> <span class="n">xfer_size</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">read_bytes</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">remote_data</span><span class="p">,</span> <span class="n">xfer_size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">read_bytes</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">total_read_bytes</span> <span class="o">+=</span> <span class="n">read_bytes</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">read_bytes</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span> <span class="c1">//sleep 2s</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sock</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">close</span><span class="p">(</span><span class="n">sock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/******************************************************************************
End of socket operations
******************************************************************************/</span>

<span class="cm">/* poll_completion */</span>
<span class="cm">/******************************************************************************
* Function: poll_completion
*
* Input
* res pointer to resources structure
*
* Output
* none
*
* Returns
* 0 on success, 1 on failure
*
* Description
* Poll the completion queue for a single event. This function will continue to
* poll the queue until MAX_POLL_CQ_TIMEOUT milliseconds have passed. (è½®è¯¢è·å¾—ä¸€ä¸ªCQäº‹ä»¶)
*
******************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">poll_completion</span><span class="p">(</span><span class="k">struct</span> <span class="n">resources</span> <span class="o">*</span><span class="n">res</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* 13 è½®è¯¢ä»»åŠ¡ç»“æœ */</span>
	<span class="k">struct</span> <span class="n">ibv_wc</span> <span class="n">wc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">poll_result</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">do</span>
	<span class="p">{</span>
		<span class="n">poll_result</span> <span class="o">=</span> <span class="n">ibv_poll_cq</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">cq</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wc</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">poll_result</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">poll_result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="cm">/* poll CQ failed */</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"poll CQ failed</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wc</span><span class="p">.</span><span class="n">status</span> <span class="o">!=</span> <span class="n">IBV_WC_SUCCESS</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"got bad completion with status: 0x%x, vendor syndrome: 0x%x</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">wc</span><span class="p">.</span><span class="n">status</span><span class="p">,</span>
					<span class="n">wc</span><span class="p">.</span><span class="n">vendor_err</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/******************************************************************************
* Function: post_send
*
* Input
* res pointer to resources structure
* opcode IBV_WR_SEND, IBV_WR_RDMA_READ or IBV_WR_RDMA_WRITE
*
* Output
* none
*
* Returns
* 0 on success, error code on failure
*
* Description
* This function will create and post a send work request
******************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">post_send</span><span class="p">(</span><span class="k">struct</span> <span class="n">resources</span> <span class="o">*</span><span class="n">res</span><span class="p">,</span> <span class="kt">int</span> <span class="n">opcode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* 11 åˆ›å»ºå‘é€ä»»åŠ¡ibv_send_wr */</span>
	<span class="k">struct</span> <span class="n">ibv_send_wr</span> <span class="n">sr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ibv_sge</span> <span class="n">sge</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ibv_send_wr</span> <span class="o">*</span><span class="n">bad_wr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="cm">/* prepare the scatter/gather entry */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sge</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sge</span><span class="p">));</span>
	<span class="n">sge</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">;</span>
	<span class="n">sge</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">MSG_SIZE</span><span class="p">;</span>
	<span class="n">sge</span><span class="p">.</span><span class="n">lkey</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">mr</span><span class="o">-&gt;</span><span class="n">lkey</span><span class="p">;</span>
	<span class="cm">/* prepare the send work request */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sr</span><span class="p">));</span>
	<span class="n">sr</span><span class="p">.</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">sr</span><span class="p">.</span><span class="n">wr_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sr</span><span class="p">.</span><span class="n">sg_list</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sge</span><span class="p">;</span>
	<span class="n">sr</span><span class="p">.</span><span class="n">num_sge</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">sr</span><span class="p">.</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">opcode</span><span class="p">;</span>
	<span class="n">sr</span><span class="p">.</span><span class="n">send_flags</span> <span class="o">=</span> <span class="n">IBV_SEND_SIGNALED</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">opcode</span> <span class="o">!=</span> <span class="n">IBV_WR_SEND</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">sr</span><span class="p">.</span><span class="n">wr</span><span class="p">.</span><span class="n">rdma</span><span class="p">.</span><span class="n">remote_addr</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">remote_props</span><span class="p">.</span><span class="n">addr</span><span class="p">;</span>
		<span class="n">sr</span><span class="p">.</span><span class="n">wr</span><span class="p">.</span><span class="n">rdma</span><span class="p">.</span><span class="n">rkey</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">remote_props</span><span class="p">.</span><span class="n">rkey</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* 12 æäº¤å‘é€ä»»åŠ¡ */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ibv_post_send</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bad_wr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"failed to post SR</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/******************************************************************************
* Function: post_receive
*
* Input
* res pointer to resources structure
*
* Output
* none
*
* Returns
* 0 on success, error code on failure
*
* Description
*
******************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">post_receive</span><span class="p">(</span><span class="k">struct</span> <span class="n">resources</span> <span class="o">*</span><span class="n">res</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* 11 åˆ›å»ºæ¥æ”¶ä»»åŠ¡ibv_resv_wr */</span>
	<span class="k">struct</span> <span class="n">ibv_recv_wr</span> <span class="n">rr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ibv_sge</span> <span class="n">sge</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ibv_recv_wr</span> <span class="o">*</span><span class="n">bad_wr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="cm">/* prepare the scatter/gather entry */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sge</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sge</span><span class="p">));</span>
	<span class="n">sge</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">;</span>
	<span class="n">sge</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">MSG_SIZE</span><span class="p">;</span>
	<span class="n">sge</span><span class="p">.</span><span class="n">lkey</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">mr</span><span class="o">-&gt;</span><span class="n">lkey</span><span class="p">;</span>
	<span class="cm">/* prepare the receive work request */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rr</span><span class="p">));</span>
	<span class="n">rr</span><span class="p">.</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">rr</span><span class="p">.</span><span class="n">wr_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rr</span><span class="p">.</span><span class="n">sg_list</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sge</span><span class="p">;</span>
	<span class="n">rr</span><span class="p">.</span><span class="n">num_sge</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* 12 æäº¤æ¥æ”¶ä»»åŠ¡ */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ibv_post_recv</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bad_wr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"failed to post RR</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/******************************************************************************
* Function: resources_destroy
*
* Input
* res pointer to resources structure
*
* Output
* none
*
* Returns
* 0 on success, 1 on failure
*
* Description
* Cleanup and deallocate all resources used
******************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">resources_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">resources</span> <span class="o">*</span><span class="n">res</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ibv_destroy_qp</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"failed to destroy QP</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">mr</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ibv_dereg_mr</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">mr</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"failed to deregister MR</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">)</span>
		<span class="n">free</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">cq</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ibv_destroy_cq</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">cq</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"failed to destroy CQ</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">pd</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ibv_dealloc_pd</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">pd</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"failed to deallocate PD</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">ib_ctx</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ibv_close_device</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">ib_ctx</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"failed to close device context</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/******************************************************************************
* Function: main
*
* Input
* argc number of items in argv
* argv command line parameters
*
* Output
* none
*
* Returns
* 0 on success, 1 on failure
*
* Description
* Main program code
******************************************************************************/</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">resources</span> <span class="n">res</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">server_ip</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">optind</span> <span class="o">==</span> <span class="n">argc</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">server_ip</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="n">optind</span><span class="p">];</span> <span class="c1">//è·å–å®¢æˆ·ç«¯è¿æ¥æœåŠ¡å™¨çš„IP</span>

	<span class="cm">/* init all of the resources, so cleanup will be easy */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">res</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">res</span><span class="p">);</span>

	<span class="cm">/* 1 è·å–è®¾å¤‡åˆ—è¡¨ */</span>
	<span class="kt">int</span> <span class="n">num_devices</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ibv_device</span> <span class="o">**</span><span class="n">dev_list</span> <span class="o">=</span> <span class="n">ibv_get_device_list</span><span class="p">(</span><span class="o">&amp;</span><span class="n">num_devices</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev_list</span> <span class="o">||</span> <span class="o">!</span><span class="n">num_devices</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"failed to get IB devices</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">main_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* 2 æ‰“å¼€è®¾å¤‡ï¼Œè·å–è®¾å¤‡ä¸Šä¸‹æ–‡ */</span>
	<span class="k">struct</span> <span class="n">ibv_device</span> <span class="o">*</span><span class="n">ib_dev</span> <span class="o">=</span> <span class="n">dev_list</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">res</span><span class="p">.</span><span class="n">ib_ctx</span> <span class="o">=</span> <span class="n">ibv_open_device</span><span class="p">(</span><span class="n">ib_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">.</span><span class="n">ib_ctx</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"failed to open device </span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">main_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* 3 é‡Šæ”¾è®¾å¤‡åˆ—è¡¨å ç”¨çš„èµ„æº */</span>
	<span class="n">ibv_free_device_list</span><span class="p">(</span><span class="n">dev_list</span><span class="p">);</span>
	<span class="n">dev_list</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ib_dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* 4 æŸ¥è¯¢è®¾å¤‡ç«¯å£çŠ¶æ€ */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ibv_query_port</span><span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">ib_ctx</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">.</span><span class="n">port_attr</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"ibv_query_port on port failed</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">main_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* 5 åˆ›å»ºPDï¼ˆProtection Domainï¼‰ */</span>
	<span class="n">res</span><span class="p">.</span><span class="n">pd</span> <span class="o">=</span> <span class="n">ibv_alloc_pd</span><span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">ib_ctx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">.</span><span class="n">pd</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"ibv_alloc_pd failed</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">main_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* 6 åˆ›å»ºCQï¼ˆComplete Queueï¼‰ */</span>
	<span class="kt">int</span> <span class="n">cq_size</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
	<span class="n">res</span><span class="p">.</span><span class="n">cq</span> <span class="o">=</span> <span class="n">ibv_create_cq</span><span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">ib_ctx</span><span class="p">,</span> <span class="n">cq_size</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">.</span><span class="n">cq</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"failed to create CQ with %u entries</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">cq_size</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">main_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* 7 æ³¨å†ŒMRï¼ˆMemory Regionï¼‰ */</span>
	<span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">MSG_SIZE</span><span class="p">;</span>
	<span class="n">res</span><span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">.</span><span class="n">buf</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"failed to malloc %Zu bytes to memory buffer</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">main_exit</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

	<span class="kt">int</span> <span class="n">mr_flags</span> <span class="o">=</span> <span class="n">IBV_ACCESS_LOCAL_WRITE</span> <span class="o">|</span> <span class="n">IBV_ACCESS_REMOTE_READ</span> <span class="o">|</span> <span class="n">IBV_ACCESS_REMOTE_WRITE</span><span class="p">;</span>
	<span class="n">res</span><span class="p">.</span><span class="n">mr</span> <span class="o">=</span> <span class="n">ibv_reg_mr</span><span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">pd</span><span class="p">,</span> <span class="n">res</span><span class="p">.</span><span class="n">buf</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">mr_flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">.</span><span class="n">mr</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"ibv_reg_mr failed with mr_flags=0x%x</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">mr_flags</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">main_exit</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">"MR was registered with addr=%p, lkey=0x%x, rkey=0x%x, flags=0x%x</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
			<span class="n">res</span><span class="p">.</span><span class="n">buf</span><span class="p">,</span> <span class="n">res</span><span class="p">.</span><span class="n">mr</span><span class="o">-&gt;</span><span class="n">lkey</span><span class="p">,</span> <span class="n">res</span><span class="p">.</span><span class="n">mr</span><span class="o">-&gt;</span><span class="n">rkey</span><span class="p">,</span> <span class="n">mr_flags</span><span class="p">);</span>

	<span class="cm">/* 8 åˆ›å»ºQPï¼ˆQueue Pairï¼‰ */</span>
	<span class="k">struct</span> <span class="n">ibv_qp_init_attr</span> <span class="n">qp_init_attr</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qp_init_attr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">qp_init_attr</span><span class="p">));</span>
	<span class="n">qp_init_attr</span><span class="p">.</span><span class="n">qp_type</span> <span class="o">=</span> <span class="n">IBV_QPT_RC</span><span class="p">;</span>
	<span class="n">qp_init_attr</span><span class="p">.</span><span class="n">sq_sig_all</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">qp_init_attr</span><span class="p">.</span><span class="n">send_cq</span> <span class="o">=</span> <span class="n">res</span><span class="p">.</span><span class="n">cq</span><span class="p">;</span>
	<span class="n">qp_init_attr</span><span class="p">.</span><span class="n">recv_cq</span> <span class="o">=</span> <span class="n">res</span><span class="p">.</span><span class="n">cq</span><span class="p">;</span>
	<span class="n">qp_init_attr</span><span class="p">.</span><span class="n">cap</span><span class="p">.</span><span class="n">max_send_wr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">qp_init_attr</span><span class="p">.</span><span class="n">cap</span><span class="p">.</span><span class="n">max_recv_wr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">qp_init_attr</span><span class="p">.</span><span class="n">cap</span><span class="p">.</span><span class="n">max_send_sge</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">qp_init_attr</span><span class="p">.</span><span class="n">cap</span><span class="p">.</span><span class="n">max_recv_sge</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">res</span><span class="p">.</span><span class="n">qp</span> <span class="o">=</span> <span class="n">ibv_create_qp</span><span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">pd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qp_init_attr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">.</span><span class="n">qp</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"failed to create QP</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">main_exit</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">"QP was created, QP number=0x%x</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">res</span><span class="p">.</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">qp_num</span><span class="p">);</span>

	<span class="cm">/* 9 äº¤æ¢æ§åˆ¶ä¿¡æ¯ */</span>
	<span class="k">struct</span> <span class="n">cm_con_data_t</span> <span class="n">local_con_data</span><span class="p">;</span>  <span class="c1">// å‘é€ç»™è¿œç¨‹ä¸»æœºçš„ä¿¡æ¯</span>
	<span class="k">struct</span> <span class="n">cm_con_data_t</span> <span class="n">remote_con_data</span><span class="p">;</span> <span class="c1">// æ¥æ”¶è¿œç¨‹ä¸»æœºå‘é€è¿‡æ¥çš„ä¿¡æ¯</span>
	<span class="k">struct</span> <span class="n">cm_con_data_t</span> <span class="n">tmp_con_data</span><span class="p">;</span>

	<span class="n">local_con_data</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">htonll</span><span class="p">((</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="n">res</span><span class="p">.</span><span class="n">buf</span><span class="p">);</span>
	<span class="n">local_con_data</span><span class="p">.</span><span class="n">rkey</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">mr</span><span class="o">-&gt;</span><span class="n">rkey</span><span class="p">);</span>
	<span class="n">local_con_data</span><span class="p">.</span><span class="n">qp_num</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">qp_num</span><span class="p">);</span>
	<span class="n">local_con_data</span><span class="p">.</span><span class="n">lid</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">port_attr</span><span class="p">.</span><span class="n">lid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sock_sync_data</span><span class="p">(</span><span class="n">server_ip</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cm_con_data_t</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">local_con_data</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">tmp_con_data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"failed to exchange connection data between sides</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">main_exit</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">remote_con_data</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">ntohll</span><span class="p">(</span><span class="n">tmp_con_data</span><span class="p">.</span><span class="n">addr</span><span class="p">);</span>
	<span class="n">remote_con_data</span><span class="p">.</span><span class="n">rkey</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">tmp_con_data</span><span class="p">.</span><span class="n">rkey</span><span class="p">);</span>
	<span class="n">remote_con_data</span><span class="p">.</span><span class="n">qp_num</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">tmp_con_data</span><span class="p">.</span><span class="n">qp_num</span><span class="p">);</span>
	<span class="n">remote_con_data</span><span class="p">.</span><span class="n">lid</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">tmp_con_data</span><span class="p">.</span><span class="n">lid</span><span class="p">);</span>
	<span class="cm">/* save the remote side attributes, we will need it for the post SR */</span>
	<span class="n">res</span><span class="p">.</span><span class="n">remote_props</span> <span class="o">=</span> <span class="n">remote_con_data</span><span class="p">;</span>
	<span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">"Remote address = 0x%"</span> <span class="n">PRIx64</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">remote_con_data</span><span class="p">.</span><span class="n">addr</span><span class="p">);</span>
	<span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">"Remote rkey = 0x%x</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">remote_con_data</span><span class="p">.</span><span class="n">rkey</span><span class="p">);</span>
	<span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">"Remote QP number = 0x%x</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">remote_con_data</span><span class="p">.</span><span class="n">qp_num</span><span class="p">);</span>
	<span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">"Remote LID = 0x%x</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">remote_con_data</span><span class="p">.</span><span class="n">lid</span><span class="p">);</span>

	<span class="cm">/* 10 è½¬æ¢QPçŠ¶æ€ */</span>
	<span class="c1">// RESET -&gt; INIT</span>
	<span class="k">struct</span> <span class="n">ibv_qp_attr</span> <span class="n">attr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">attr</span><span class="p">));</span>
	<span class="n">attr</span><span class="p">.</span><span class="n">qp_state</span> <span class="o">=</span> <span class="n">IBV_QPS_INIT</span><span class="p">;</span>
	<span class="n">attr</span><span class="p">.</span><span class="n">port_num</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// IB ç«¯å£å·</span>
	<span class="n">attr</span><span class="p">.</span><span class="n">pkey_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">attr</span><span class="p">.</span><span class="n">qp_access_flags</span> <span class="o">=</span> <span class="n">IBV_ACCESS_LOCAL_WRITE</span> <span class="o">|</span> <span class="n">IBV_ACCESS_REMOTE_READ</span> <span class="o">|</span> <span class="n">IBV_ACCESS_REMOTE_WRITE</span><span class="p">;</span>
	<span class="n">flags</span> <span class="o">=</span> <span class="n">IBV_QP_STATE</span> <span class="o">|</span> <span class="n">IBV_QP_PKEY_INDEX</span> <span class="o">|</span> <span class="n">IBV_QP_PORT</span> <span class="o">|</span> <span class="n">IBV_QP_ACCESS_FLAGS</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ibv_modify_qp</span><span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">qp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"failed to modify QP state to INIT</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>

	<span class="c1">//INIT -&gt; RTR(Ready To Receive)</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">attr</span><span class="p">));</span>
	<span class="n">attr</span><span class="p">.</span><span class="n">qp_state</span> <span class="o">=</span> <span class="n">IBV_QPS_RTR</span><span class="p">;</span>
	<span class="n">attr</span><span class="p">.</span><span class="n">path_mtu</span> <span class="o">=</span> <span class="n">IBV_MTU_256</span><span class="p">;</span>
	<span class="n">attr</span><span class="p">.</span><span class="n">dest_qp_num</span> <span class="o">=</span> <span class="n">res</span><span class="p">.</span><span class="n">remote_props</span><span class="p">.</span><span class="n">qp_num</span><span class="p">;</span>
	<span class="n">attr</span><span class="p">.</span><span class="n">rq_psn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">attr</span><span class="p">.</span><span class="n">max_dest_rd_atomic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">attr</span><span class="p">.</span><span class="n">min_rnr_timer</span> <span class="o">=</span> <span class="mh">0x12</span><span class="p">;</span>
	<span class="n">attr</span><span class="p">.</span><span class="n">ah_attr</span><span class="p">.</span><span class="n">is_global</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">attr</span><span class="p">.</span><span class="n">ah_attr</span><span class="p">.</span><span class="n">dlid</span> <span class="o">=</span> <span class="n">res</span><span class="p">.</span><span class="n">remote_props</span><span class="p">.</span><span class="n">lid</span><span class="p">;</span>
	<span class="n">attr</span><span class="p">.</span><span class="n">ah_attr</span><span class="p">.</span><span class="n">sl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">attr</span><span class="p">.</span><span class="n">ah_attr</span><span class="p">.</span><span class="n">src_path_bits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">attr</span><span class="p">.</span><span class="n">ah_attr</span><span class="p">.</span><span class="n">port_num</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">flags</span> <span class="o">=</span> <span class="n">IBV_QP_STATE</span> <span class="o">|</span> <span class="n">IBV_QP_AV</span> <span class="o">|</span> <span class="n">IBV_QP_PATH_MTU</span> <span class="o">|</span> <span class="n">IBV_QP_DEST_QPN</span> <span class="o">|</span> <span class="n">IBV_QP_RQ_PSN</span> <span class="o">|</span> <span class="n">IBV_QP_MAX_DEST_RD_ATOMIC</span> <span class="o">|</span> <span class="n">IBV_QP_MIN_RNR_TIMER</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ibv_modify_qp</span><span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">qp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"failed to modify QP state to RTR</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>

	<span class="c1">//RTR -&gt; RTS(Ready To Send)</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">attr</span><span class="p">));</span>
	<span class="n">attr</span><span class="p">.</span><span class="n">qp_state</span> <span class="o">=</span> <span class="n">IBV_QPS_RTS</span><span class="p">;</span>
	<span class="n">attr</span><span class="p">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="mh">0x12</span><span class="p">;</span>
	<span class="n">attr</span><span class="p">.</span><span class="n">retry_cnt</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
	<span class="n">attr</span><span class="p">.</span><span class="n">rnr_retry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">attr</span><span class="p">.</span><span class="n">sq_psn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">attr</span><span class="p">.</span><span class="n">max_rd_atomic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">flags</span> <span class="o">=</span> <span class="n">IBV_QP_STATE</span> <span class="o">|</span> <span class="n">IBV_QP_TIMEOUT</span> <span class="o">|</span> <span class="n">IBV_QP_RETRY_CNT</span> <span class="o">|</span> <span class="n">IBV_QP_RNR_RETRY</span> <span class="o">|</span> <span class="n">IBV_QP_SQ_PSN</span> <span class="o">|</span> <span class="n">IBV_QP_MAX_QP_RD_ATOMIC</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ibv_modify_qp</span><span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">qp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"failed to modify QP state to RTS</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>

	<span class="kt">int</span> <span class="n">choice</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n\n\n</span><span class="s">"</span><span class="p">);</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">"*********************************************************************************************</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">"* 1:RDMA_READ 2:RDMA_WRITE 3:SEND 4:RECEIVE 5:Read Local Buffer 6:Write Local Buffer 7:Exit *</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">"*********************************************************************************************</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">"please input your choice : "</span><span class="p">);</span>
		<span class="n">scanf</span><span class="p">(</span><span class="s">"%d"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">choice</span><span class="p">);</span>
		<span class="n">getchar</span><span class="p">();</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">choice</span><span class="p">)</span>
		<span class="p">{</span>
		<span class="k">case</span> <span class="mi">1</span><span class="p">:</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MSG_SIZE</span><span class="p">);</span>
			<span class="n">post_send</span><span class="p">(</span><span class="o">&amp;</span><span class="n">res</span><span class="p">,</span> <span class="n">IBV_WR_RDMA_READ</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">poll_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">res</span><span class="p">))</span>
			<span class="p">{</span>
				<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"poll completion failed 2</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">else</span>
			<span class="p">{</span>
				<span class="n">printf</span><span class="p">(</span><span class="s">"Reading remote's buffer(addr:0x%x, rkey:0x%x) : %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">res</span><span class="p">.</span><span class="n">remote_props</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">res</span><span class="p">.</span><span class="n">remote_props</span><span class="p">.</span><span class="n">rkey</span><span class="p">,</span> <span class="n">res</span><span class="p">.</span><span class="n">buf</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mi">2</span><span class="p">:</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MSG_SIZE</span><span class="p">);</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">"Writing remote's buffer(addr:0x%x, rkey:0x%x) : "</span><span class="p">,</span> <span class="n">res</span><span class="p">.</span><span class="n">remote_props</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">res</span><span class="p">.</span><span class="n">remote_props</span><span class="p">.</span><span class="n">rkey</span><span class="p">);</span>
			<span class="n">fgets</span><span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">buf</span><span class="p">,</span> <span class="n">MSG_SIZE</span><span class="p">,</span> <span class="n">stdin</span><span class="p">);</span>
			<span class="n">post_send</span><span class="p">(</span><span class="o">&amp;</span><span class="n">res</span><span class="p">,</span> <span class="n">IBV_WR_RDMA_WRITE</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">poll_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">res</span><span class="p">))</span>
			<span class="p">{</span>
				<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"poll completion failed 2</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">else</span>
			<span class="p">{</span>
				<span class="n">printf</span><span class="p">(</span><span class="s">"success</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mi">3</span><span class="p">:</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MSG_SIZE</span><span class="p">);</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">"Sending : "</span><span class="p">);</span>
			<span class="n">fgets</span><span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">buf</span><span class="p">,</span> <span class="n">MSG_SIZE</span><span class="p">,</span> <span class="n">stdin</span><span class="p">);</span>
			<span class="n">post_send</span><span class="p">(</span><span class="o">&amp;</span><span class="n">res</span><span class="p">,</span> <span class="n">IBV_WR_SEND</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">poll_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">res</span><span class="p">))</span>
			<span class="p">{</span>
				<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"poll completion failed 2</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">else</span>
			<span class="p">{</span>
				<span class="n">printf</span><span class="p">(</span><span class="s">"success</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mi">4</span><span class="p">:</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">"receiving: "</span><span class="p">);</span>
			<span class="n">post_receive</span><span class="p">(</span><span class="o">&amp;</span><span class="n">res</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">poll_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">res</span><span class="p">))</span>
			<span class="p">{</span>
				<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"poll completion failed 2</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">else</span>
			<span class="p">{</span>
				<span class="n">printf</span><span class="p">(</span><span class="s">"%s"</span><span class="p">,</span> <span class="n">res</span><span class="p">.</span><span class="n">buf</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mi">5</span><span class="p">:</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">"Reading local buffer(addr:0x%x): %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="n">res</span><span class="p">.</span><span class="n">buf</span><span class="p">,</span> <span class="n">res</span><span class="p">.</span><span class="n">buf</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mi">6</span><span class="p">:</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MSG_SIZE</span><span class="p">);</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">"Writing local buffer(addr:0x%x) : %s"</span><span class="p">,</span> <span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="n">res</span><span class="p">.</span><span class="n">buf</span><span class="p">,</span> <span class="n">res</span><span class="p">.</span><span class="n">buf</span><span class="p">);</span>
			<span class="n">fgets</span><span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">buf</span><span class="p">,</span> <span class="n">MSG_SIZE</span><span class="p">,</span> <span class="n">stdin</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mi">7</span><span class="p">:</span>
			<span class="k">goto</span> <span class="n">main_exit</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">"invalid choice.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">main_exit:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">resources_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">res</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"failed to destroy resources</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">"</span><span class="se">\n</span><span class="s">test result is %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="å‚è€ƒææ–™">å‚è€ƒææ–™</h2>

<ul>
  <li><a href="http://www.mellanox.com/related-docs/prod_software/RDMA_Aware_Programming_user_manual.pdf">å®˜æ–¹æ–‡æ¡£</a></li>
  <li><a href="https://www.rdmamojo.com">åšå®¢</a></li>
</ul>
:ET
I"¹<h2 id="project1-å®ç°ä¸€ä¸ªå¤šçº¿ç¨‹å¹¶å‘è®¿é—®çš„é˜Ÿåˆ—">Project1: å®ç°ä¸€ä¸ªå¤šçº¿ç¨‹å¹¶å‘è®¿é—®çš„é˜Ÿåˆ—</h2>

<p>Implement a multi-access threaded queue with multiple threads inserting and multiple threads extracting from the queue. Use mutex-locks to synchronize access to the queue. Document the time for 1000 insertions and 1000 extractions each by 64 insertions threads (Producers) and 64 extraction threads (Consumers).
è¯­è¨€é™åˆ¶ï¼šC/C++/Java
PSï¼šä¸èƒ½ç›´æ¥ä½¿ç”¨ STL æˆ–è€… JDK ä¸­ç°æœ‰çš„å¹¶å‘è®¿é—®é˜Ÿåˆ—ï¼Œè¯·åŸºäºæ™®é€šçš„ queue æˆ–è‡ªè¡Œå®ç°</p>

<h3 id="å®ç°æ€è·¯">å®ç°æ€è·¯</h3>

<p>åœ¨ç»§æ‰¿ STL ä¸­çš„é€‚é…å™¨<code class="highlighter-rouge">queue</code>çš„åŸºç¡€ä¸Šï¼Œæ¯æ¬¡å¯¹å®¹å™¨å†…å…ƒç´ çš„è®¿é—®å’Œä¿®æ”¹éƒ½éœ€è¦å…ˆä¸Šé”ï¼Œç»“æŸåè§£é”ã€‚</p>

<p>ç”±äºè®¿é—®æ“ä½œå¯ä»¥æ˜¯<code class="highlighter-rouge">const</code>çš„ï¼Œå› æ­¤è¿™ä¸ªé”éœ€è¦æ˜¯<code class="highlighter-rouge">mutable</code>çš„ã€‚</p>

<h3 id="è¿è¡Œç»“æœ">è¿è¡Œç»“æœ</h3>

<p>æ‰€ç”¨æœºå™¨å‹å·ä¸º VAIO Z Flip 2016ï¼ŒåŸºæœ¬é…ç½®å¦‚ä¸‹ï¼š</p>

<ul>
  <li>Intel(R) Core(TM) i7-6567U CPU @3.30GHZ 3.31GHz</li>
  <li>8.00GB RAM</li>
</ul>

<p>ç¼–è¯‘è¿è¡Œ main.cpp åï¼Œå¾—åˆ°å¦‚ä¸‹è¿è¡Œç»“æœï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>elapsed time: 0.146981s
</code></pre></div></div>

<p>å³è¿›è¡Œ 64 ä¸ªç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…è®¿é—®ä¹‹åä¸€å…±æ¶ˆè€—äº†çº¦ 0.146981sã€‚</p>

<h3 id="æºä»£ç ">æºä»£ç </h3>

<h4 id="wkmultiaccessqueuehpp">wkMultiAccessQueue.hpp</h4>

<p>éœ€è¦å¼€ C++11ã€‚</p>

<pre><code class="language-hpp">#ifndef _wkMultiAccessQueue_hpp_
#define _wkMultiAccessQueue_hpp_
#include &lt;queue&gt;
#include &lt;mutex&gt;
namespace wk
{
template &lt;class T&gt;
class MultiAccessQueue : std::queue&lt;T&gt;
{
private:
	mutable std::mutex mu;

public:
	void push(T val)
	{
		std::lock_guard&lt;std::mutex&gt; guard(mu);
		std::queue&lt;T&gt;::push(val);
	}
	void pop()
	{
		std::lock_guard&lt;std::mutex&gt; guard(mu);
		std::queue&lt;T&gt;::pop();
	}
	T front() const
	{
		std::lock_guard&lt;std::mutex&gt; guard(mu);
		return std::queue&lt;T&gt;::front();
	}
};
} // namespace wk
#endif
</code></pre>

<h4 id="maincpp">main.cpp</h4>

<p>éœ€è¦å¼€ C++11ã€‚</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;chrono&gt;
#include &lt;vector&gt;
#include &lt;thread&gt;
#include &lt;iostream&gt;
#include "wkMultiAccessQueue.hpp"
</span><span class="n">wk</span><span class="o">::</span><span class="n">MultiAccessQueue</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">q</span><span class="p">;</span>
<span class="kt">void</span> <span class="nf">producer</span><span class="p">(</span><span class="kt">int</span> <span class="n">cnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cnt</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">q</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="nf">consumer</span><span class="p">(</span><span class="kt">int</span> <span class="n">cnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cnt</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">q</span><span class="p">.</span><span class="n">pop</span><span class="p">();</span>
<span class="p">}</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
	<span class="k">auto</span> <span class="n">begin</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">system_clock</span><span class="o">::</span><span class="n">now</span><span class="p">();</span>
	<span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="o">&gt;</span> <span class="n">vt</span><span class="p">(</span><span class="mi">64</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="n">it</span> <span class="o">:</span> <span class="n">vt</span><span class="p">)</span>
		<span class="n">it</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="p">(</span><span class="n">producer</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="n">it</span> <span class="o">:</span> <span class="n">vt</span><span class="p">)</span>
		<span class="n">it</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>
	<span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="n">it</span> <span class="o">:</span> <span class="n">vt</span><span class="p">)</span>
		<span class="n">it</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="p">(</span><span class="n">consumer</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="n">it</span> <span class="o">:</span> <span class="n">vt</span><span class="p">)</span>
		<span class="n">it</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>
	<span class="k">auto</span> <span class="n">end</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">system_clock</span><span class="o">::</span><span class="n">now</span><span class="p">();</span>
	<span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">duration</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="n">elapsed_seconds</span> <span class="o">=</span> <span class="n">end</span> <span class="o">-</span> <span class="n">begin</span><span class="p">;</span>
	<span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"elapsed time: "</span> <span class="o">&lt;&lt;</span> <span class="n">elapsed_seconds</span><span class="p">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">"s</span><span class="se">\n</span><span class="s">"</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
:ET
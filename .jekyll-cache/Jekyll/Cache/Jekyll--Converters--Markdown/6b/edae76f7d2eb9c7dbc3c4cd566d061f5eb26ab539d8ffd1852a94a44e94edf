I"á¶<h2 id="å®éªŒç®€ä»‹">å®éªŒç®€ä»‹</h2>

<p>ç”¨ MPI å’Œ CUDA å®ç°é“¾è¡¨æ±‚åºï¼ˆlinked list rankingï¼‰ç®—æ³•ï¼Œå¹¶ä¸ä¸²è¡Œç¨‹åºæ¯”è¾ƒã€‚</p>

<ul>
  <li>è¾“å…¥ï¼šä¸€ä¸ª N å…ƒç´ çš„å•å‘é“¾è¡¨ï¼Œè¯¥é“¾è¡¨æ”¾åœ¨ä¸€ä¸ªé•¿åº¦ä¸º N çš„å‘é‡ä¸­ã€‚é“¾è¡¨çš„æ¯ä¸€ä¸ªå…ƒç´ ï¼ˆé™¤é“¾å°¾çš„ä¸€ä¸ªï¼‰éƒ½æœ‰ä¸€ä¸ªåç»§çš„æ•°ç»„ä¸‹æ ‡ã€‚é“¾å°¾çš„å…ƒç´ çš„åç»§ä¸º<code class="highlighter-rouge">-1</code>ã€‚</li>
  <li>è¾“å‡ºï¼šå®šä¹‰é“¾è¡¨å…ƒç´ çš„åºå·ï¼ˆrankï¼‰ä¸ºâ€œå…¶åç»§çš„æ€»æ•°â€ï¼Œä¾‹å¦‚é“¾å¤´çš„åºå·ä¸º N-1ã€é“¾å°¾çš„åºå·ä¸º 0ã€‚å‘é‡ä¸­çš„å…ƒç´ ä¸ä¸€å®šæŒ‰ç…§é“¾è¡¨çš„é¡ºåºå­˜æ”¾ã€‚è¦æ±‚ç®—å‡ºæ¯ä¸€ä¸ªå‘é‡å…ƒç´ çš„åºå·ã€‚</li>
</ul>

<h2 id="å®éªŒç¯å¢ƒ">å®éªŒç¯å¢ƒ</h2>

<p>å®éªŒåœ¨è€å¸ˆæä¾›çš„è®¡ç®—é›†ç¾¤çš„ä¸€ä¸ªèŠ‚ç‚¹ä¸Šè¿›è¡Œã€‚å•èŠ‚ç‚¹çš„æ˜¾å¡é…ç½®å¦‚ä¸‹ï¼š</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>nvdia-smi
Mon Dec  2 08:38:49 2019
+-----------------------------------------------------------------------------+
| NVIDIA-SMI 410.48                 Driver Version: 410.48                    |
|-------------------------------+----------------------+----------------------+
| GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |
| Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |
|<span class="o">===============================</span>+<span class="o">======================</span>+<span class="o">======================</span>|
|   0  Tesla V100-PCIE...  On   | 00000000:3B:00.0 Off |                    0 |
| N/A   30C    P0    24W / 250W |      0MiB / 16130MiB |      0%      Default |
+-------------------------------+----------------------+----------------------+

+-----------------------------------------------------------------------------+
| Processes:                                                       GPU Memory |
|  GPU       PID   Type   Process name                             Usage      |
|<span class="o">=============================================================================</span>|
|  No running processes found                                                 |
+-----------------------------------------------------------------------------+
</code></pre></div></div>

<h2 id="å®éªŒè¿‡ç¨‹ä¸åˆ†æ">å®éªŒè¿‡ç¨‹ä¸åˆ†æ</h2>

<p>List Ranking æ˜¯ä¸€ä¸ªæ¯”è¾ƒç»å…¸çš„ç ”ç©¶å¹¶è¡Œç®—æ³•è®¾è®¡çš„é—®é¢˜ï¼Œå› ä¸ºè¿™ä¸ªé—®é¢˜çš„å¹¶è¡Œç®—æ³•ç›¸å¯¹äºä¸²è¡Œç‰ˆæœ¬å¾ˆéš¾æœ‰ååˆ†æ˜æ˜¾çš„é€Ÿåº¦æ”¹è¿›ã€‚ä½†æ˜¯å¹¶è¡ŒåŒ–çš„å¥½å¤„å¹¶ä¸ä»…ä»…æ˜¯æé€Ÿã€‚</p>

<p>æ¯”å¦‚ï¼Œå•æœºä¸Šçš„å†…å­˜æ€»é‡å¾ˆå¤šæƒ…å†µä¸‹æ˜¯ä¸è¶³å¤Ÿçš„ï¼Œè€Œå¤šæœºå¹¶è¡Œçš„æ—¶å€™å¯ä»¥ä½¿ç”¨æ›´å¤§çš„å†…å­˜ã€‚é’ˆå¯¹è¿™ä¸€é—®é¢˜ï¼Œå¹¶è¡ŒåŒ–çš„ä¼˜ç‚¹æ˜¯å¯ä»¥é€šè¿‡æ‰©å……ç¡¬ä»¶çš„è§„æ¨¡ä»è€Œæ‰©å……èƒ½å¤Ÿå¤„ç†é—®é¢˜çš„è§„æ¨¡ï¼Œè¿™æ˜¯ä¸²è¡Œç¨‹åºæ¯”ä¸äº†çš„ã€‚</p>

<h3 id="è°ƒåº¦è„šæœ¬list_rankingpbs">è°ƒåº¦è„šæœ¬<code class="highlighter-rouge">list_ranking.pbs</code></h3>

<p>è¿™é‡Œç”±äºä¸´è¿‘æœŸæœ«ï¼Œé›†ç¾¤èµ„æºæ¯”è¾ƒç´§å¼ ï¼Œæ‰€æœ‰çš„è°ƒåº¦éƒ½åªå ç”¨é›†ç¾¤ä¸Šçš„ä¸€ä¸ªèŠ‚ç‚¹è¿›è¡Œã€‚MPI ä½¿ç”¨ä¸€å°ä¸»æœºä¸Šçš„ 32 ä¸ªæ ¸è¿›è¡Œå¹¶è¡Œï¼›CUDA ä½¿ç”¨èŠ‚ç‚¹ä¸Šçš„å•å¼  v100 æ˜¾å¡ã€‚ä¸ºæ–¹ä¾¿èµ·è§ï¼Œæˆ‘å°†æ‰€æœ‰çš„æµ‹è¯•ä»£ç å†™è¿›äº†ä¸€ä¸ªæµ‹è¯•è„šæœ¬<code class="highlighter-rouge">list_ranking.pbs</code>ä¸­ï¼Œè¿™æ ·ç›´æ¥å¯¹è¿™ä¸ªè„šæœ¬è¿›è¡Œè°ƒåº¦è¿è¡Œå³å¯è‡ªåŠ¨è¿è¡Œå®Œæ•´å®éªŒå¹¶è¿›è¡Œè®¡æ—¶ã€‚</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#PBS -N list_ranking</span>
<span class="c">#PBS -l nodes=1:ppn=32:gpus=1</span>
<span class="c">#PBS -j oe</span>
<span class="c">#PBS -q gpu</span>
<span class="nb">source</span> /public/software/profile.d/mpi_openmpi-intel-2.1.2.sh
<span class="nb">source</span> /public/software/profile.d/cuda10.0.sh
<span class="nb">cd</span> <span class="nv">$PBS_O_WORKDIR</span>

gcc gen_list_ranking_data.c <span class="nt">-o</span> gen_list_ranking_data <span class="nt">-std</span><span class="o">=</span>c99
./gen_list_ranking_data <span class="o">&gt;</span> list_ranking_data.txt

gcc list_ranking.c <span class="nt">-o</span> list_ranking <span class="nt">-std</span><span class="o">=</span>c99
<span class="nb">time</span> ./list_ranking &lt; list_ranking_data.txt <span class="o">&gt;</span> list_ranking_out.txt

mpicc list_ranking_mpi.c <span class="nt">-o</span> list_ranking_mpi <span class="nt">-std</span><span class="o">=</span>c99
<span class="nb">time </span>mpiexec <span class="nt">-machinefile</span> <span class="nv">$PBS_NODEFILE</span> ./list_ranking_mpi &lt; list_ranking_data.txt <span class="o">&gt;</span> list_ranking_mpi_out.txt

nvcc list_ranking_cuda.cu <span class="nt">-o</span> list_ranking_cuda
<span class="nb">time</span> ./list_ranking_cuda &lt; list_ranking_data.txt <span class="o">&gt;</span> list_ranking_cuda_out.txt
</code></pre></div></div>

<h3 id="è¿è¡Œæ—¶é—´list_rankingo17502">è¿è¡Œæ—¶é—´<code class="highlighter-rouge">list_ranking.o17502</code></h3>

<p>è‡ªä¸Šè€Œä¸‹åˆ†åˆ«æ˜¯ä¸²è¡Œç®—æ³•çš„æ—¶é—´ï¼ˆ<code class="highlighter-rouge">1.977s</code>ï¼‰ï¼ŒMPI ç®—æ³•çš„æ—¶é—´ï¼ˆ<code class="highlighter-rouge">5.976s</code>ï¼‰ï¼ŒCUDA ç®—æ³•çš„æ—¶é—´ï¼ˆ<code class="highlighter-rouge">3.246s</code>ï¼‰ã€‚å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œå®ç°çš„ä¸¤ä¸ªå¹¶è¡Œç®—æ³•éƒ½åœ¨ä¸è¿‡åˆ†å¢åŠ å¹¶è¡Œå¼€é”€çš„æƒ…å†µä¸‹å¢åŠ äº†ä¸²è¡Œç®—æ³•çš„å¯æ‰©å±•æ€§ã€‚</p>

<p><strong>è¿™ä¸ªé—®é¢˜ä¸­å¹¶è¡Œç®—æ³•æ˜¯ä¸å¯èƒ½å¿«äºåŒç­‰æƒ…å†µä¸‹çš„ä¸²è¡Œç®—æ³•çš„</strong>ï¼Œå› ä¸ºä¸²è¡Œç®—æ³•çš„æ—¶é—´å¤æ‚åº¦æ˜¯$O(n)$ï¼Œè€Œè¯»å…¥è¿™ä¸ªå‘é‡çš„æ—¶é—´å¤æ‚åº¦å·²ç»æ˜¯$O(n)$äº†ï¼Œå¹¶è¡Œç®—æ³•æ— è®ºå¦‚ä½•éƒ½éœ€è¦å…ˆè¯»å…¥å‘é‡ï¼Œæ—¶é—´å¤æ‚åº¦ä¸Šä¸å¯èƒ½ä¼˜äº$O(n)$ã€‚</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
real	0m1.977s
user	0m1.710s
sys	0m0.176s

real	0m5.976s
user	1m20.123s
sys	0m32.837s

real	0m3.246s
user	0m2.251s
sys	0m0.806s
</code></pre></div></div>

<h3 id="æ„é€ ç”Ÿæˆæ•°æ®gen_list_ranking_datac">æ„é€ ç”Ÿæˆæ•°æ®<code class="highlighter-rouge">gen_list_ranking_data.c</code></h3>

<p>æ­¤å¤„æˆ‘ä½¿ç”¨äº†è€å¸ˆæä¾›çš„æ•°æ®ç”Ÿæˆå™¨ã€‚</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
</span>
<span class="kt">int</span> <span class="o">*</span><span class="nf">gen_linked_list_1</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">N</span><span class="p">)</span>
<span class="p">{</span>

    <span class="kt">int</span> <span class="o">*</span><span class="n">list</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">!=</span> <span class="n">list</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">free</span><span class="p">(</span><span class="n">list</span><span class="p">);</span>
        <span class="n">list</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">N</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"N is 0, exit</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">list</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">N</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">list</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Can not allocate memory for output array</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">N</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
        <span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

    <span class="k">return</span> <span class="n">list</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">//iå’Œjçš„åç»§å…ƒç´ äº¤æ¢ä½ç½®</span>
<span class="kt">void</span> <span class="nf">swap</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">list</span><span class="p">,</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="kt">int</span> <span class="n">j</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">i</span> <span class="o">==</span> <span class="n">j</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>

    <span class="kt">int</span> <span class="n">p</span> <span class="o">=</span> <span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="c1">//ä¿å­˜iåç»§å…ƒç´ ä¸‹æ ‡p</span>
    <span class="kt">int</span> <span class="n">q</span> <span class="o">=</span> <span class="n">list</span><span class="p">[</span><span class="n">j</span><span class="p">];</span> <span class="c1">//ä¿å­˜jåç»§å…ƒç´ ä¸‹æ ‡q</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">||</span> <span class="n">q</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span> <span class="c1">//å¦‚æœæœ‰ä¸€ä¸ªæ²¡æœ‰åç»§å…ƒç´ </span>

    <span class="kt">int</span> <span class="n">pnext</span> <span class="o">=</span> <span class="n">list</span><span class="p">[</span><span class="n">p</span><span class="p">];</span> <span class="c1">//ä¿å­˜pçš„åç»§å…ƒç´ ä¸‹æ ‡</span>
    <span class="kt">int</span> <span class="n">qnext</span> <span class="o">=</span> <span class="n">list</span><span class="p">[</span><span class="n">q</span><span class="p">];</span> <span class="c1">//ä¿å­˜qçš„åç»§å…ƒç´ ä¸‹æ ‡</span>

    <span class="c1">//i,jçš„åç»§å…ƒç´ äº¤æ¢ä½ç½®</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">==</span> <span class="n">j</span><span class="p">)</span>
    <span class="p">{</span> <span class="c1">//jæ˜¯içš„åç»§</span>
        <span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">q</span><span class="p">;</span>
        <span class="n">list</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">list</span><span class="p">[</span><span class="n">q</span><span class="p">];</span>
        <span class="n">list</span><span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">q</span><span class="p">)</span>
    <span class="p">{</span> <span class="c1">//iæ˜¯jçš„åç»§</span>
        <span class="n">list</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
        <span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">list</span><span class="p">[</span><span class="n">p</span><span class="p">];</span>
        <span class="n">list</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">q</span><span class="p">;</span>     <span class="c1">//içš„åç»§æ”¹ä¸ºq</span>
        <span class="n">list</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>     <span class="c1">//jçš„åç»§æ”¹ä¸ºp</span>
        <span class="n">list</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">qnext</span><span class="p">;</span> <span class="c1">//pçš„åç»§å…ƒç´ æ”¹ä¸ºåŸæ¥qçš„åç»§</span>
        <span class="n">list</span><span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="o">=</span> <span class="n">pnext</span><span class="p">;</span> <span class="c1">//qçš„åç»§å…ƒç´ æ”¹ä¸ºåŸæ¥pçš„åç»§</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="o">*</span><span class="nf">gen_linked_list_2</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">N</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="o">*</span><span class="n">list</span><span class="p">;</span>

    <span class="n">list</span> <span class="o">=</span> <span class="n">gen_linked_list_1</span><span class="p">(</span><span class="n">N</span><span class="p">);</span>

    <span class="kt">int</span> <span class="n">p</span> <span class="o">=</span> <span class="n">N</span> <span class="o">/</span> <span class="mi">5</span><span class="p">;</span>

    <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">k</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">N</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">int</span> <span class="n">k</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="n">p</span><span class="p">)</span> <span class="o">%</span> <span class="n">N</span><span class="p">;</span>
        <span class="n">swap</span><span class="p">(</span><span class="n">list</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">list</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>

    <span class="kt">int</span> <span class="n">N</span> <span class="o">=</span> <span class="mi">10000000</span><span class="p">;</span>
    <span class="kt">int</span> <span class="o">*</span><span class="n">qq</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
    <span class="c1">// qq=gen_linked_list_1(N);</span>
    <span class="c1">// printf("\nhere is the list\n");</span>
    <span class="c1">// for(i=0; i&lt;N; i++)</span>
    <span class="c1">// printf("%3d ", qq[i]);</span>
    <span class="c1">// printf("\n");</span>
    <span class="c1">// free(qq);</span>
    <span class="n">qq</span> <span class="o">=</span> <span class="n">gen_linked_list_2</span><span class="p">(</span><span class="n">N</span><span class="p">);</span>
    <span class="c1">//printf("\nhere is the new list\n");</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"%3d "</span><span class="p">,</span> <span class="n">N</span><span class="p">);</span> <span class="c1">//è¾“å‡ºé“¾è¡¨å…ƒç´ ä¸ªæ•°</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">N</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="c1">//è¾“å‡ºé“¾è¡¨å…¨éƒ¨å…ƒç´ </span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"%3d "</span><span class="p">,</span> <span class="n">qq</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>

    <span class="n">free</span><span class="p">(</span><span class="n">qq</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>ç»ˆç«¯æ‰§è¡Œä¸‹è¿°æŒ‡ä»¤ï¼Œå¾—åˆ°ç”¨äºæµ‹è¯•çš„æ•°æ®<code class="highlighter-rouge">list_ranking_data.txt</code>ã€‚</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gcc gen_list_ranking_data.c <span class="nt">-o</span> gen_list_ranking_data <span class="nt">-std</span><span class="o">=</span>c99
./gen_list_ranking_data <span class="o">&gt;</span> list_ranking_data.txt
</code></pre></div></div>

<p><code class="highlighter-rouge">list_ranking_data.txt</code>æœ‰ç€å¦‚ä¸‹çš„ç»“æ„ï¼Œè¿™é‡Œåªæ”¾å‡ºå‘é‡çš„å‰å››ä¸ªå…ƒç´ ã€‚</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>10000000
<span class="nt">-1</span> 4000014 2000003 4000030 ...
</code></pre></div></div>

<h3 id="ä¸²è¡Œæ‰«æç®—æ³•">ä¸²è¡Œæ‰«æç®—æ³•</h3>

<p>æœ€ç®€å•çš„ä¸²è¡Œç®—æ³•å³æ‰«ææ•´ä¸ªåˆ—è¡¨ã€‚è§£é‡Šä¸€ä¸‹æ•´ä¸ªç®—æ³•çš„è¿‡ç¨‹ï¼š</p>

<ol>
  <li>è¯»å…¥å‘é‡<code class="highlighter-rouge">v</code></li>
  <li>æ ¹æ®<code class="highlighter-rouge">v</code>è®¡ç®—æ¯ä¸ªå…ƒç´ çš„å‰é©±<code class="highlighter-rouge">pre</code>ï¼ŒåŒæ—¶æ‰¾å‡ºé“¾è¡¨å°¾<code class="highlighter-rouge">last</code></li>
  <li>ä»é“¾è¡¨å°¾<code class="highlighter-rouge">last</code>å¼€å§‹é¡ºæ¬¡è®¿é—®å‰é©±<code class="highlighter-rouge">pre</code>ï¼Œéå†çš„é¡ºåºå°±æ˜¯æˆ‘ä»¬è¦æ±‚çš„é“¾è¡¨åºã€‚</li>
</ol>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
</span><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="n">last</span><span class="p">;</span>
	<span class="n">scanf</span><span class="p">(</span><span class="s">"%d"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">n</span><span class="p">);</span>
	<span class="kt">int</span> <span class="o">*</span><span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="o">*</span> <span class="n">n</span><span class="p">),</span>
		<span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="o">*</span> <span class="n">n</span><span class="p">),</span>
		<span class="o">*</span><span class="n">pre</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="o">*</span> <span class="n">n</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">scanf</span><span class="p">(</span><span class="s">"%d"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">last</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">pre</span><span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">u</span> <span class="o">=</span> <span class="n">last</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">--</span><span class="n">i</span><span class="p">,</span> <span class="n">u</span> <span class="o">=</span> <span class="n">pre</span><span class="p">[</span><span class="n">u</span><span class="p">])</span>
		<span class="n">a</span><span class="p">[</span><span class="n">u</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">"%d "</span><span class="p">,</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">free</span><span class="p">(</span><span class="n">pre</span><span class="p">);</span>
	<span class="n">free</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
	<span class="n">free</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>ç»ˆç«¯æ‰§è¡Œä¸‹å±æŒ‡ä»¤ï¼Œå¯ä»¥è®¡æ—¶æ‰§è¡Œå¹¶å°†ç»“æœå†™å…¥<code class="highlighter-rouge">list_ranking_out.txt</code>ã€‚</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gcc list_ranking.c <span class="nt">-o</span> list_ranking <span class="nt">-std</span><span class="o">=</span>c99
<span class="nb">time</span> ./list_ranking &lt; list_ranking_data.txt <span class="o">&gt;</span> list_ranking_out.txt
</code></pre></div></div>

<p><code class="highlighter-rouge">list_ranking_out.txt</code>å‰å››ä¸ªå…ƒç´ ä¸ºå¦‚ä¸‹çš„ç»“æ„ï¼Œæ‰‹åŠ¨æ£€æŸ¥ç¬¬ä¸€ä¸ªå…ƒç´ çš„ ranking æ˜¯<code class="highlighter-rouge">9999999</code>ï¼Œæ˜¯æ­£ç¡®çš„ã€‚</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>9999999 5999984 9999997 5999968 ...
</code></pre></div></div>

<p><strong>ç›´æ¥ä¸²è¡Œæ‰«æç®—æ³•ä¿®æ”¹å‡ºæ¥çš„å¹¶è¡Œç®—æ³•ä¸ä¼šæœ‰ç†æƒ³çš„åŠ é€Ÿæ•ˆæœã€‚</strong>ç†ç”±æ˜¯ï¼Œä¸‹é¢è¿™æ®µä»£ç ä¸­ï¼Œé‡å¤æ‰§è¡Œ<code class="highlighter-rouge">u = pre[u]</code>ä»é“¾è¡¨å°¾å¼€å§‹ä¾æ¬¡å‘å‰æ‰¾å‰é©±èŠ‚ç‚¹ï¼Œè¿™ä¸ªè¿‡ç¨‹æ˜¯ä¸²è¡Œçš„ï¼Œæœ‰å¾ªç¯ä¾èµ–ï¼Œä¸å¯ä»¥ç›´æ¥åˆ’åˆ†åˆ°å¤šè¿›ç¨‹å¹¶è¡Œæ‰§è¡Œã€‚</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">u</span> <span class="o">=</span> <span class="n">last</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">--</span><span class="n">i</span><span class="p">,</span> <span class="n">u</span> <span class="o">=</span> <span class="n">pre</span><span class="p">[</span><span class="n">u</span><span class="p">])</span>
	<span class="n">a</span><span class="p">[</span><span class="n">u</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
</code></pre></div></div>

<h3 id="mpi-å®ç°çš„-wyllie-ç®—æ³•list_ranking_mpic">MPI å®ç°çš„ Wyllie ç®—æ³•<code class="highlighter-rouge">list_ranking_mpi.c</code></h3>

<p>å³ä½¿ç”¨ point jumpingï¼ˆç‚¹å€å¢ï¼‰çš„æ–¹æ³•æ¥è®¡ç®—å„ä¸ª rankï¼Œæ˜¯æœ€ç®€å•çš„å¹¶è¡Œç®—æ³•ã€‚</p>

<blockquote>
  <p>Wyllie ç®—æ³•åŸç†ï¼š</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span> <span class="c1"># åˆå§‹åŒ–ï¼Œå…¶ä¸­vä»£è¡¨åˆå§‹å‘é‡ï¼Œå³æ¯ä¸ªèŠ‚ç‚¹åç»§
</span>    <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">&gt;=</span><span class="mi">0</span> <span class="c1"># aä»£è¡¨æ¯ä¸ªèŠ‚ç‚¹
</span><span class="k">while</span> <span class="n">exists</span><span class="p">(</span><span class="n">i</span> <span class="o">=&gt;</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">):</span> <span class="c1"># æ­¤éƒ¨åˆ†å¹¶è¡Œæ‰§è¡Œï¼Œæ¯è½®è¿­ä»£è¦åŒæ­¥
</span>    <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">a</span><span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
    <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
</code></pre></div>  </div>
</blockquote>

<p>å¦‚ä¸Šé¢çš„ä¼ªä»£ç ï¼Œåˆå§‹åŒ–è¿‡ç¨‹å’Œæ¯è½®è¿­ä»£éƒ½æ˜¯å¯ä»¥åˆ’åˆ†åˆ°å¤šè¿›ç¨‹æ‰§è¡Œçš„ã€‚å½“ç„¶ï¼Œè¿™é‡Œå¾—åˆ°çš„<code class="highlighter-rouge">a</code>æ˜¯åˆ°é“¾è¡¨å°¾éƒ¨çš„è·ç¦»ï¼Œç”¨é“¾è¡¨é•¿åº¦ç›¸å‡å°±èƒ½å¾—åˆ°æˆ‘ä»¬æ‰€éœ€è¦çš„åºå·ã€‚</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;mpi.h&gt;
</span><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">comSize</span><span class="p">,</span> <span class="n">comRank</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>
	<span class="n">MPI_Init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">argc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">argv</span><span class="p">);</span>
	<span class="n">MPI_Comm_size</span><span class="p">(</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">comSize</span><span class="p">);</span>
	<span class="n">MPI_Comm_rank</span><span class="p">(</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">comRank</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">comRank</span><span class="p">)</span>
		<span class="n">scanf</span><span class="p">(</span><span class="s">"%d"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">n</span><span class="p">);</span>

	<span class="n">MPI_Bcast</span><span class="p">(</span>
		<span class="o">&amp;</span><span class="n">n</span><span class="p">,</span>
		<span class="mi">1</span><span class="p">,</span>
		<span class="n">MPI_INT</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span>
		<span class="n">MPI_COMM_WORLD</span><span class="p">);</span>

	<span class="kt">int</span> <span class="n">myLen</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="n">comSize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">comSize</span><span class="p">,</span>
		<span class="n">myBeg</span> <span class="o">=</span> <span class="n">comRank</span> <span class="o">*</span> <span class="n">myLen</span><span class="p">,</span>
		<span class="o">*</span><span class="n">myV</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="o">*</span> <span class="n">myLen</span><span class="p">),</span>
		<span class="o">*</span><span class="n">myA</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="o">*</span> <span class="n">myLen</span><span class="p">),</span>
		<span class="o">*</span><span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="o">*</span> <span class="n">n</span><span class="p">),</span>
		<span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="o">*</span> <span class="n">n</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">comRank</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
			<span class="n">scanf</span><span class="p">(</span><span class="s">"%d"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">MPI_Bcast</span><span class="p">(</span>
		<span class="n">v</span><span class="p">,</span>
		<span class="n">n</span><span class="p">,</span>
		<span class="n">MPI_INT</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span>
		<span class="n">MPI_COMM_WORLD</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">myLen</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">myV</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">myBeg</span><span class="p">];</span>
		<span class="n">myA</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">myV</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">MPI_Allgather</span><span class="p">(</span>
		<span class="n">myA</span><span class="p">,</span>
		<span class="n">myLen</span><span class="p">,</span>
		<span class="n">MPI_INT</span><span class="p">,</span>
		<span class="n">a</span><span class="p">,</span>
		<span class="n">myLen</span><span class="p">,</span>
		<span class="n">MPI_INT</span><span class="p">,</span>
		<span class="n">MPI_COMM_WORLD</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">myLen</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">myBeg</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">myA</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">myBeg</span><span class="p">]</span> <span class="o">+</span> <span class="n">a</span><span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">myBeg</span><span class="p">]];</span>
				<span class="n">myV</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">myBeg</span><span class="p">]];</span>
			<span class="p">}</span>

		<span class="n">MPI_Allgather</span><span class="p">(</span>
			<span class="n">myA</span><span class="p">,</span>
			<span class="n">myLen</span><span class="p">,</span>
			<span class="n">MPI_INT</span><span class="p">,</span>
			<span class="n">a</span><span class="p">,</span>
			<span class="n">myLen</span><span class="p">,</span>
			<span class="n">MPI_INT</span><span class="p">,</span>
			<span class="n">MPI_COMM_WORLD</span><span class="p">);</span>

		<span class="n">MPI_Allgather</span><span class="p">(</span>
			<span class="n">myV</span><span class="p">,</span>
			<span class="n">myLen</span><span class="p">,</span>
			<span class="n">MPI_INT</span><span class="p">,</span>
			<span class="n">v</span><span class="p">,</span>
			<span class="n">myLen</span><span class="p">,</span>
			<span class="n">MPI_INT</span><span class="p">,</span>
			<span class="n">MPI_COMM_WORLD</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">comRank</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">"%d "</span><span class="p">,</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">free</span><span class="p">(</span><span class="n">myV</span><span class="p">);</span>
	<span class="n">free</span><span class="p">(</span><span class="n">myA</span><span class="p">);</span>
	<span class="n">free</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
	<span class="n">free</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
	<span class="n">MPI_Finalize</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div>

<p>ç»ˆç«¯æ‰§è¡Œä¸‹è¿°æŒ‡ä»¤ï¼Œå¯ä»¥è®¡æ—¶æ‰§è¡Œå¹¶å°†ç»“æœå†™å…¥<code class="highlighter-rouge">list_ranking_mpi_out.txt</code>ã€‚</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mpicc list_ranking_mpi.c <span class="nt">-o</span> list_ranking_mpi <span class="nt">-std</span><span class="o">=</span>c99
<span class="nb">time </span>mpiexec <span class="nt">-machinefile</span> <span class="nv">$PBS_NODEFILE</span> ./list_ranking_mpi &lt; list_ranking_data.txt <span class="o">&gt;</span> list_ranking_mpi_out.txt
</code></pre></div></div>

<p><code class="highlighter-rouge">list_ranking_mpi_out.txt</code>å‰å››ä¸ªå…ƒç´ ä¸ºå¦‚ä¸‹çš„ç»“æ„ï¼Œæ‰‹åŠ¨æ£€æŸ¥ç¬¬ä¸€ä¸ªå…ƒç´ çš„ ranking æ˜¯<code class="highlighter-rouge">9999999</code>ï¼Œæ˜¯æ­£ç¡®çš„ï¼›<code class="highlighter-rouge">list_ranking_mpi_out.txt</code>ä¸<code class="highlighter-rouge">list_ranking_out.txt</code>å®Œå…¨ç›¸åŒã€‚</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>9999999 5999984 9999997 5999968 ...
</code></pre></div></div>

<h3 id="cuda-å®ç°çš„-wyllie-ç®—æ³•list_ranking_cudacu">CUDA å®ç°çš„ Wyllie ç®—æ³•<code class="highlighter-rouge">list_ranking_cuda.cu</code></h3>

<p>å¦ä¸€ç§å¹¶è¡Œé“¾è¡¨æ±‚åºçš„ SMP ç®—æ³•[Helman and JaJa, 1999]éœ€è¦æå‰çŸ¥é“é“¾è¡¨ä¸­ç­‰åˆ†ç‚¹çš„åˆ†å¸ƒï¼Œä¸æ˜¯å¾ˆé€‚åˆæœ¬ä¾‹ï¼Œå› æ­¤ç”¨ CUDA å®ç°çš„ä»ç„¶æ˜¯ Wyllie ç®—æ³•ã€‚</p>

<p>ç›¸æ¯”äº MPI å®ç°çš„ç‰ˆæœ¬ï¼Œè¿™é‡Œæ²¡æœ‰äº†èŠ‚ç‚¹å¹¿æ’­ Bcast å’Œå…¨èšé›† Allgather çš„å¼€é”€ï¼Œå› æ­¤æ—¶é—´ä¸Šå¿«äº†éå¸¸å¤šã€‚ç„¶è€Œï¼Œä»ç„¶éœ€è¦è€ƒè™‘çš„æ˜¯ï¼Œæ ¸å‡½æ•° work å¯¹<code class="highlighter-rouge">v[v[idx]]</code>å’Œ<code class="highlighter-rouge">a[v[idx]]</code>çš„è®¿é—®æ²¡æœ‰å¯¹é½ï¼Œè¿™æ˜¯ç®—æ³•çš„ç“¶é¢ˆæ‰€åœ¨ã€‚</p>

<pre><code class="language-clike">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
void __global__ init(int n, int *v, int *a)
{
	int idx = blockIdx.x * blockDim.x + threadIdx.x;
	a[idx] = v[idx] &gt;= 0;
}
void __global__ work(int n, int *v, int *a, int *new_v, int *new_a)
{
	int idx = blockIdx.x * blockDim.x + threadIdx.x;
	if (v[idx] &gt;= 0)
	{
		new_a[idx] = a[idx] + a[v[idx]];
		new_v[idx] = v[v[idx]];
	}
}
int main()
{
	int n;
	scanf("%d", &amp;n);

	int *v = (int *)malloc(sizeof(int) * n),
		*d_v,
		*d_v1,
		*d_a,
		*d_a1,
		block = 32, grid = n / block;

	for (int i = 0; i &lt; n; ++i)
		scanf("%d", &amp;v[i]);

	cudaMalloc(&amp;d_a, sizeof(int) * n);
	cudaMalloc(&amp;d_a1, sizeof(int) * n);
	cudaMalloc(&amp;d_v, sizeof(int) * n);
	cudaMalloc(&amp;d_v1, sizeof(int) * n);
	cudaMemcpy(d_v, v, sizeof(int) * n, cudaMemcpyHostToDevice);

	init&lt;&lt;&lt;grid, block&gt;&gt;&gt;(n, d_v, d_a);
	cudaDeviceSynchronize();

	for (int j = 1; j &lt; n; j &lt;&lt;= 1)
	{
		work&lt;&lt;&lt;grid, block&gt;&gt;&gt;(n, d_v, d_a, d_v1, d_a1);
		cudaDeviceSynchronize();
		int *tmp;
		tmp = d_v, d_v = d_v1, d_v1 = tmp;
		tmp = d_a, d_a = d_a1, d_a1 = tmp;
	}

	cudaMemcpy(v, d_a, sizeof(int) * n, cudaMemcpyDeviceToHost);

	for (int i = 0; i &lt; n; ++i)
		printf("%d ", n - 1 - v[i]);

	cudaFree(d_v);
	cudaFree(d_a);
	cudaFree(d_v1);
	cudaFree(d_a1);
	free(v);
}
</code></pre>

<p>ç»ˆç«¯æ‰§è¡Œä¸‹è¿°æŒ‡ä»¤ï¼Œå¯ä»¥è®¡æ—¶æ‰§è¡Œå¹¶å°†ç»“æœå†™å…¥<code class="highlighter-rouge">list_ranking_cuda_out.txt</code>ã€‚</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">nvcc</span> <span class="n">list_ranking_cuda</span><span class="p">.</span><span class="n">cu</span> <span class="o">-</span><span class="n">o</span> <span class="n">list_ranking_cuda</span>
<span class="n">time</span> <span class="p">.</span><span class="o">/</span><span class="n">list_ranking_cuda</span> <span class="o">&lt;</span> <span class="n">list_ranking_data</span><span class="p">.</span><span class="n">txt</span> <span class="o">&gt;</span> <span class="n">list_ranking_cuda_out</span><span class="p">.</span><span class="n">txt</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">list_ranking_cuda_out.txt</code>å‰å››ä¸ªå…ƒç´ ä¸ºå¦‚ä¸‹çš„ç»“æ„ï¼Œæ‰‹åŠ¨æ£€æŸ¥ç¬¬ä¸€ä¸ªå…ƒç´ çš„ ranking æ˜¯<code class="highlighter-rouge">9999999</code>ï¼Œæ˜¯æ­£ç¡®çš„ï¼›<code class="highlighter-rouge">list_ranking_cuda_out.txt</code>ä¸<code class="highlighter-rouge">list_ranking_out.txt</code>å®Œå…¨ç›¸åŒã€‚</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>9999999 5999984 9999997 5999968 ...
</code></pre></div></div>

<h2 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h2>

<ul>
  <li><a href="http://staff.ustc.edu.cn/~csli/graduate/algorithms/book6/chap30.htm">http://staff.ustc.edu.cn/~csli/graduate/algorithms/book6/chap30.htm</a></li>
  <li><a href="https://en.wikipedia.org/wiki/Pointer_jumping">https://en.wikipedia.org/wiki/Pointer_jumping</a></li>
  <li><a href="http://www.cs.cmu.edu/~scandal/alg/listrank.html">http://www.cs.cmu.edu/~scandal/alg/listrank.html</a></li>
  <li><a href="https://www.cs.cmu.edu/~glmiller/Publications/Papers/ReMiMo93.pdf">https://www.cs.cmu.edu/~glmiller/Publications/Papers/ReMiMo93.pdf</a></li>
  <li><a href="http://cdn.iiit.ac.in/cdn/cstar.iiit.ac.in/~kkishore/ics152-rehman.pdf">http://cdn.iiit.ac.in/cdn/cstar.iiit.ac.in/~kkishore/ics152-rehman.pdf</a></li>
  <li>D. Bader, G. Cong, and J. Feo. On the Architectural Requirements for Efficient Execution of Graph Algorithms. International Conference on Parallel Processing (ICPP), 2005, pages 547-556, June 2005.</li>
  <li>D. A. Bader, V. Agarwal, and K. Madduri. On the Design and Analysis of Irregular Algorithms on the Cell Processor: A Case Study of List Ranking. In 21st IEEE International Parallel and Distributed Processing Symposium (IPDPS), pages 1-10. IEEE, 2007.</li>
  <li>D. A. Bader and G. Cong. A Fast, Parallel Spanning Tree Algorithm for Symmetric Multiprocessors (SMPs). Journal of Parallel and Distributed Computing, 65(9):994 - 1006, 2005.</li>
  <li><a href="https://link.springer.com/content/pdf/10.1007%2FBFb0056600.pdf">https://link.springer.com/content/pdf/10.1007%2FBFb0056600.pdf</a></li>
</ul>
:ET
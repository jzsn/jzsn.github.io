I"ğH<h2 id="é¢˜ç›®è¦æ±‚">é¢˜ç›®è¦æ±‚</h2>

<p>å°†æ–‡ä»¶â€œæ€§èƒ½ä¼˜åŒ–å®éªŒåˆ†æ.pdfâ€ä¸­è®¨è®ºçš„ç¨‹åºç¼–è¯‘è¿è¡Œï¼Œå¹¶è®°å½•è¿è¡Œæ—¶é—´ï¼Œç„¶ååˆ©ç”¨ Linux æ€§èƒ½å‰–æå·¥å…· perf åˆ†æç¨‹åºè¢«åŠ é€Ÿçš„åŸå› ã€‚</p>

<h2 id="å®éªŒè¿‡ç¨‹">å®éªŒè¿‡ç¨‹</h2>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;
</span><span class="k">typedef</span> <span class="k">struct</span> <span class="n">pixel</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">red</span><span class="p">,</span> <span class="n">green</span><span class="p">,</span> <span class="n">blue</span><span class="p">;</span>
<span class="p">}</span> <span class="n">pixel</span><span class="p">;</span>
<span class="cp">#define RIDX(i, j, dim) ((i) * (dim) + (j))
</span><span class="kt">void</span> <span class="nf">naive_rotate</span><span class="p">(</span><span class="kt">int</span> <span class="n">dim</span><span class="p">,</span> <span class="n">pixel</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="n">pixel</span> <span class="o">*</span><span class="n">dst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dim</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">dim</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="n">dst</span><span class="p">[</span><span class="n">RIDX</span><span class="p">(</span><span class="n">dim</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">dim</span><span class="p">)]</span> <span class="o">=</span> <span class="n">src</span><span class="p">[</span><span class="n">RIDX</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">dim</span><span class="p">)];</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="nf">rotate1</span><span class="p">(</span><span class="kt">int</span> <span class="n">dim</span><span class="p">,</span> <span class="n">pixel</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="n">pixel</span> <span class="o">*</span><span class="n">dst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">ii</span><span class="p">,</span> <span class="n">jj</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="n">dim</span><span class="p">;</span> <span class="n">ii</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">jj</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">jj</span> <span class="o">&lt;</span> <span class="n">dim</span><span class="p">;</span> <span class="n">jj</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">ii</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ii</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="n">jj</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">jj</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
					<span class="n">dst</span><span class="p">[</span><span class="n">RIDX</span><span class="p">(</span><span class="n">dim</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">dim</span><span class="p">)]</span> <span class="o">=</span> <span class="n">src</span><span class="p">[</span><span class="n">RIDX</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">dim</span><span class="p">)];</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="nf">rotate2</span><span class="p">(</span><span class="kt">int</span> <span class="n">dim</span><span class="p">,</span> <span class="n">pixel</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="n">pixel</span> <span class="o">*</span><span class="n">dst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">ii</span><span class="p">,</span> <span class="n">jj</span><span class="p">,</span> <span class="n">k</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="n">dim</span><span class="p">;</span> <span class="n">ii</span> <span class="o">+=</span> <span class="mi">32</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">jj</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">jj</span> <span class="o">&lt;</span> <span class="n">dim</span><span class="p">;</span> <span class="n">jj</span> <span class="o">+=</span> <span class="mi">32</span><span class="p">)</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">ii</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ii</span> <span class="o">+</span> <span class="mi">32</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="n">jj</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">jj</span> <span class="o">+</span> <span class="mi">32</span><span class="p">;</span> <span class="n">j</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span>
					<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span> <span class="o">++</span><span class="n">k</span><span class="p">)</span>
					<span class="p">{</span>
						<span class="n">dst</span><span class="p">[</span><span class="n">RIDX</span><span class="p">(</span><span class="n">dim</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">k</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">dim</span><span class="p">)]</span> <span class="o">=</span> <span class="n">src</span><span class="p">[</span><span class="n">RIDX</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">dim</span><span class="p">)];</span>
						<span class="n">dst</span><span class="p">[</span><span class="n">RIDX</span><span class="p">(</span><span class="n">dim</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">k</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dim</span><span class="p">)]</span> <span class="o">=</span> <span class="n">src</span><span class="p">[</span><span class="n">RIDX</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">dim</span><span class="p">)];</span>
						<span class="n">dst</span><span class="p">[</span><span class="n">RIDX</span><span class="p">(</span><span class="n">dim</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">k</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dim</span><span class="p">)]</span> <span class="o">=</span> <span class="n">src</span><span class="p">[</span><span class="n">RIDX</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">dim</span><span class="p">)];</span>
						<span class="n">dst</span><span class="p">[</span><span class="n">RIDX</span><span class="p">(</span><span class="n">dim</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">k</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">dim</span><span class="p">)]</span> <span class="o">=</span> <span class="n">src</span><span class="p">[</span><span class="n">RIDX</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">dim</span><span class="p">)];</span>
					<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#define COPY(d, s) *(d) = *(s)
</span><span class="kt">void</span> <span class="nf">rotate3</span><span class="p">(</span><span class="kt">int</span> <span class="n">dim</span><span class="p">,</span> <span class="n">pixel</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="n">pixel</span> <span class="o">*</span><span class="n">dst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dim</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">32</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="n">dim</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">j</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">pixel</span> <span class="o">*</span><span class="n">dptr</span> <span class="o">=</span> <span class="n">dst</span> <span class="o">+</span> <span class="n">RIDX</span><span class="p">(</span><span class="n">dim</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">dim</span><span class="p">);</span>
			<span class="n">pixel</span> <span class="o">*</span><span class="n">sptr</span> <span class="o">=</span> <span class="n">src</span> <span class="o">+</span> <span class="n">RIDX</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">dim</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="o">++</span><span class="n">k</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">COPY</span><span class="p">(</span><span class="n">dptr</span> <span class="o">+</span> <span class="n">k</span><span class="p">,</span> <span class="n">sptr</span><span class="p">);</span>
				<span class="n">sptr</span> <span class="o">+=</span> <span class="n">dim</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#define N (1 &lt;&lt; 13)
</span><span class="n">pixel</span> <span class="n">s</span><span class="p">[</span><span class="n">N</span> <span class="o">*</span> <span class="n">N</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="n">N</span> <span class="o">*</span> <span class="n">N</span><span class="p">];</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
	<span class="n">naive_rotate</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">d</span><span class="p">);</span>
	<span class="n">rotate1</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">d</span><span class="p">);</span>
	<span class="n">rotate2</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">d</span><span class="p">);</span>
	<span class="n">rotate3</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">d</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>åœ¨è€å¸ˆæä¾›çš„æœºå™¨ä¸Šè¿è¡Œä¸‹è¿°æŒ‡ä»¤ï¼ˆåªæˆªå–äº†æŠ¥å‘Šä¸­å’Œä¼˜åŒ–éƒ¨åˆ†ç›¸å…³çš„ä¸‰ä¸ªå‡½æ•°ï¼‰ã€‚</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>lnszyd@201-NF5280M3:~<span class="nv">$ </span>gcc <span class="nt">-g</span> a.c
lnszyd@201-NF5280M3:~<span class="nv">$ </span><span class="nb">sudo </span>perf record <span class="nt">-g</span> ./a.out
<span class="o">[</span> perf record: Woken up 10 <span class="nb">times </span>to write data <span class="o">]</span>
<span class="o">[</span> perf record: Captured and wrote 2.468 MB perf.data <span class="o">(</span>28285 samples<span class="o">)</span> <span class="o">]</span>
lnszyd@201-NF5280M3:~<span class="nv">$ </span><span class="nb">sudo </span>perf report <span class="nt">-g</span> <span class="nt">-i</span> perf.data
-   52.13%    47.82%  a.out    a.out              <span class="o">[</span>.] naive_rotate
   + 47.82% 0x2be258d4c544155
   - 4.31% naive_rotate
      - 2.48% page_fault
         - 2.48% do_page_fault
            - 2.41% __do_page_fault
               - 2.23% handle_mm_fault
                  - 1.87% __handle_mm_fault
                     - 1.31% alloc_pages_vma
                        - 1.30% __alloc_pages_nodemask
                             1.12% clear_page_erms
      - 0.77% swapgs_restore_regs_and_return_to_usermode
           prepare_exit_to_usermode
-   24.30%    23.90%  a.out    a.out              <span class="o">[</span>.] rotate1
     23.90% 0x2be258d4c544155
        __libc_start_main
        main
        rotate1
-   11.86%    11.68%  a.out    a.out              <span class="o">[</span>.] rotate3
     11.68% 0x2be258d4c544155
        __libc_start_main
        main
        rotate3
-   11.72%    11.49%  a.out    a.out              <span class="o">[</span>.] rotate2
     11.49% 0x2be258d4c544155
        __libc_start_main
        main
        rotate2
</code></pre></div></div>

<p>å¯ä»¥çœ‹åˆ°ï¼Œå‡½æ•°æŒ‰ç…§è¿è¡Œæ—¶é—´ä»å¤§åˆ°å°çš„æ’åˆ—ä¾æ¬¡ä¸º<code class="highlighter-rouge">naive_rotate</code>ã€<code class="highlighter-rouge">rotate1</code>ã€<code class="highlighter-rouge">rotate_3</code>ã€<code class="highlighter-rouge">rotate2</code>ã€‚</p>

<p>åˆ†æå…·ä½“åŸå› ï¼š<code class="highlighter-rouge">rotate1</code>ç›¸å¯¹äº<code class="highlighter-rouge">naive_rotate</code>ï¼ŒæŒ‰ç…§<code class="highlighter-rouge">4*4</code>çš„å¤§å°å¯¹çŸ©å½¢åˆ†å—ï¼Œæé«˜äº†ç¼“å­˜è®¿é—®çš„å±€éƒ¨æ€§ã€‚è€Œ<code class="highlighter-rouge">rotate2</code>ç›¸å¯¹äº<code class="highlighter-rouge">rotate1</code>åˆ†å—æ›´å¤§ï¼Œå› æ­¤æ‹¥æœ‰æ›´å¥½çš„å†…å­˜å±€éƒ¨æ€§ï¼Œè¿›ä¸€æ­¥å‡å°‘äº† Cache Missã€‚è€Œ<code class="highlighter-rouge">rotate3</code>ä¸<code class="highlighter-rouge">rotate2</code>ç›¸æ¯”è¿è¡Œæ—¶é—´å‡ ä¹æ²¡æœ‰å˜åŒ–ï¼Œæ¨æµ‹åœ¨è¿™ä¸ªè¿è¡Œç¯å¢ƒä¸Šå­˜å‚¨å™¨å†™æ—¶é—´çš„å½±å“ä¸æ˜¯å¾ˆå¤§ï¼Œè°ƒæ•´å†™åœ°å€è¿ç»­æ²¡æœ‰å¸¦æ¥å¾ˆå¤§æ”¶ç›Šã€‚</p>

<p>æ­¤å¤–ï¼Œå½“è°ƒå° N è‡³<code class="highlighter-rouge">1 &lt;&lt; 8</code>æ—¶ï¼Œä¼šå¾—åˆ°å®Œå…¨ä¸åŒçš„ç»“æœï¼ˆ<code class="highlighter-rouge">rotate3</code>é€Ÿåº¦è¿œæ…¢äº<code class="highlighter-rouge">naive_rotate</code>ï¼‰ã€‚è¿™è¯´æ˜ï¼Œè°ƒæ•´çŸ©é˜µåˆ†å—çš„æ—¶å€™éœ€è¦æ ¹æ®å…·ä½“æœºå™¨çš„ç¼“å­˜é…ç½®æ¥å†³å®šï¼Œå¦åˆ™åè€Œä¼šå¸¦æ¥é¢å¤–çš„å¼€é”€ã€‚</p>
:ET